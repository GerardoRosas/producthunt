(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{rozv:function(t,e,n){(function(t){!function(e){"use strict";try{(function(){e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function r(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var i=function(){return(i=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function o(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function a(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(s(arguments[e]));return t}function h(t){for(var e=[],n=0,r=0;r<t.length;r++){var i=t.charCodeAt(r);i<128?e[n++]=i:(i<2048?e[n++]=i>>6|192:(55296==(64512&i)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&t.charCodeAt(++r)),e[n++]=i>>18|240,e[n++]=i>>12&63|128):e[n++]=i>>12|224,e[n++]=i>>6&63|128),e[n++]=63&i|128)}return e}function l(t){try{return d.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null}var u={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},c=function(t,e){if(!t)throw p(e)},p=function(t){return new Error("Firebase Database ("+u.SDK_VERSION+") INTERNAL ASSERT FAILED: "+t)},d={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],i=0;i<t.length;i+=3){var o=t[i],s=i+1<t.length,a=s?t[i+1]:0,h=i+2<t.length,l=h?t[i+2]:0,u=o>>2,c=(3&o)<<4|a>>4,p=(15&a)<<2|l>>6,d=63&l;h||(d=64,s||(p=64)),r.push(n[u],n[c],n[p],n[d])}return r.join("")},encodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(h(t),e)},decodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){for(var e=[],n=0,r=0;n<t.length;){var i=t[n++];if(i<128)e[r++]=String.fromCharCode(i);else if(191<i&&i<224){var o=t[n++];e[r++]=String.fromCharCode((31&i)<<6|63&o)}else if(239<i&&i<365){var s=((7&i)<<18|(63&(o=t[n++]))<<12|(63&(a=t[n++]))<<6|63&t[n++])-65536;e[r++]=String.fromCharCode(55296+(s>>10)),e[r++]=String.fromCharCode(56320+(1023&s))}else{o=t[n++];var a=t[n++];e[r++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&a)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray:function(t,e){this.init_();for(var n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],i=0;i<t.length;){var o=n[t.charAt(i++)],s=i<t.length?n[t.charAt(i)]:0,a=++i<t.length?n[t.charAt(i)]:64,h=++i<t.length?n[t.charAt(i)]:64;if(++i,null==o||null==s||null==a||null==h)throw Error();var l=o<<2|s>>4;if(r.push(l),64!==a){var u=s<<4&240|a>>2;if(r.push(u),64!==h){var c=a<<6&192|h;r.push(c)}}}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},f=(_.prototype.wrapCallback=function(t){var e=this;return function(n,r){n?e.reject(n):e.resolve(r),"function"==typeof t&&(e.promise.catch((function(){})),1===t.length?t(n):t(n,r))}},_);function _(){var t=this;this.reject=function(){},this.resolve=function(){},this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))}function y(){return"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test("undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:"")}function v(){return!0===u.NODE_ADMIN}var g,m=(r(C,g=Error),C);function C(t,e){var n=g.call(this,e)||this;return n.code=t,n.name="FirebaseError",Object.setPrototypeOf(n,C.prototype),Error.captureStackTrace&&Error.captureStackTrace(n,E.prototype.create),n}var E=(w.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r,i=e[0]||{},o=this.service+"/"+t,s=this.errors[t],a=s?(r=i,s.replace(b,(function(t,e){var n=r[e];return null!=n?n.toString():"<"+e+"?>"}))):"Error",h=this.serviceName+": "+a+" ("+o+").",l=new m(o,h),u=0,c=Object.keys(i);u<c.length;u++){var p=c[u];"_"!==p.slice(-1)&&(p in l&&console.warn('Overwriting FirebaseError base field "'+p+'" can cause unexpected behavior.'),l[p]=i[p])}return l},w);function w(t,e,n){this.service=t,this.serviceName=e,this.errors=n}var b=/\{\$([^}]+)}/g;function S(t){return JSON.parse(t)}function T(t){return JSON.stringify(t)}function I(t){var e={},n={},r={},i="";try{var o=t.split(".");e=S(l(o[0])||""),n=S(l(o[1])||""),i=o[2],r=n.d||{},delete n.d}catch(t){}return{header:e,claims:n,data:r,signature:i}}function N(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function R(t,e){return Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0}function P(t){for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function D(t,e,n){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(r[i]=e.call(n,t[i],i,t));return r}var O,x,k,F=(A.prototype.reset=function(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0},A.prototype.compress_=function(t,e){e=e||0;var n=this.W_;if("string"==typeof t)for(var r=0;r<16;r++)n[r]=t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3),e+=4;else for(r=0;r<16;r++)n[r]=t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3],e+=4;for(r=16;r<80;r++){var i=n[r-3]^n[r-8]^n[r-14]^n[r-16];n[r]=4294967295&(i<<1|i>>>31)}var o,s,a=this.chain_[0],h=this.chain_[1],l=this.chain_[2],u=this.chain_[3],c=this.chain_[4];for(r=0;r<80;r++)s=r<40?r<20?(o=u^h&(l^u),1518500249):(o=h^l^u,1859775393):r<60?(o=h&l|u&(h|l),2400959708):(o=h^l^u,3395469782),i=(a<<5|a>>>27)+o+c+s+n[r]&4294967295,c=u,u=l,l=4294967295&(h<<30|h>>>2),h=a,a=i;this.chain_[0]=this.chain_[0]+a&4294967295,this.chain_[1]=this.chain_[1]+h&4294967295,this.chain_[2]=this.chain_[2]+l&4294967295,this.chain_[3]=this.chain_[3]+u&4294967295,this.chain_[4]=this.chain_[4]+c&4294967295},A.prototype.update=function(t,e){if(null!=t){void 0===e&&(e=t.length);for(var n=e-this.blockSize,r=0,i=this.buf_,o=this.inbuf_;r<e;){if(0===o)for(;r<=n;)this.compress_(t,r),r+=this.blockSize;if("string"==typeof t){for(;r<e;)if(i[o]=t.charCodeAt(r),++r,++o===this.blockSize){this.compress_(i),o=0;break}}else for(;r<e;)if(i[o]=t[r],++r,++o===this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=e}},A.prototype.digest=function(){var t=[],e=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var n=this.blockSize-1;56<=n;n--)this.buf_[n]=255&e,e/=256;this.compress_(this.buf_);var r=0;for(n=0;n<5;n++)for(var i=24;0<=i;i-=8)t[r]=this.chain_[n]>>i&255,++r;return t},A);function A(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(var t=1;t<this.blockSize;++t)this.pad_[t]=0;this.reset()}function L(t,e,n,r){var i;if(r<e?i="at least "+e:n<r&&(i=0===n?"none":"no more than "+n),i)throw new Error(t+" failed: Was called with "+r+(1===r?" argument.":" arguments.")+" Expects "+i+".")}function M(t,e,n){var r="";switch(e){case 1:r=n?"first":"First";break;case 2:r=n?"second":"Second";break;case 3:r=n?"third":"Third";break;case 4:r=n?"fourth":"Fourth";break;default:throw new Error("errorPrefix called with argumentNumber > 4.  Need to update it?")}return t+" failed: "+r+" argument "}function W(t,e,n,r){if((!r||n)&&"function"!=typeof n)throw new Error(M(t,e,r)+"must be a valid function.")}function Q(t,e,n,r){if((!r||n)&&("object"!=typeof n||null===n))throw new Error(M(t,e,r)+"must be a valid context object.")}function q(t){for(var e=0,n=0;n<t.length;n++){var r=t.charCodeAt(n);r<128?e++:r<2048?e+=2:55296<=r&&r<=56319?(e+=4,n++):e+=3}return e}function U(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function V(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var i=(new Date).toISOString(),o=B[e];if(!o)throw new Error("Attempted to log a message with an invalid logType (value: "+e+")");console[o].apply(console,U(["["+i+"]  "+t.name+":"],n))}}(k=x=x||{})[k.DEBUG=0]="DEBUG",k[k.VERBOSE=1]="VERBOSE",k[k.INFO=2]="INFO",k[k.WARN=3]="WARN",k[k.ERROR=4]="ERROR",k[k.SILENT=5]="SILENT",x.DEBUG,x.VERBOSE,x.INFO,x.WARN,x.ERROR,x.SILENT;var H=x.INFO,B=((O={})[x.DEBUG]="log",O[x.VERBOSE]="log",O[x.INFO]="info",O[x.WARN]="warn",O[x.ERROR]="error",O),j=(Object.defineProperty(Y.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in x))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=t},enumerable:!0,configurable:!0}),Object.defineProperty(Y.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!0,configurable:!0}),Object.defineProperty(Y.prototype,"userLogHandler",{get:function(){return this._userLogHandler},set:function(t){this._userLogHandler=t},enumerable:!0,configurable:!0}),Y.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,U([this,x.DEBUG],t)),this._logHandler.apply(this,U([this,x.DEBUG],t))},Y.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,U([this,x.VERBOSE],t)),this._logHandler.apply(this,U([this,x.VERBOSE],t))},Y.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,U([this,x.INFO],t)),this._logHandler.apply(this,U([this,x.INFO],t))},Y.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,U([this,x.WARN],t)),this._logHandler.apply(this,U([this,x.WARN],t))},Y.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,U([this,x.ERROR],t)),this._logHandler.apply(this,U([this,x.ERROR],t))},Y);function Y(t){this.name=t,this._logLevel=H,this._logHandler=V,this._userLogHandler=null}var K=(z.prototype.setInstantiationMode=function(t){return this.instantiationMode=t,this},z.prototype.setMultipleInstances=function(t){return this.multipleInstances=t,this},z.prototype.setServiceProps=function(t){return this.serviceProps=t,this},z);function z(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY"}var G=(X.prototype.set=function(t,e){null==e?this.domStorage_.removeItem(this.prefixedName_(t)):this.domStorage_.setItem(this.prefixedName_(t),T(e))},X.prototype.get=function(t){var e=this.domStorage_.getItem(this.prefixedName_(t));return null==e?null:S(e)},X.prototype.remove=function(t){this.domStorage_.removeItem(this.prefixedName_(t))},X.prototype.prefixedName_=function(t){return this.prefix_+t},X.prototype.toString=function(){return this.domStorage_.toString()},X);function X(t){this.domStorage_=t,this.prefix_="firebase:"}var $=(J.prototype.set=function(t,e){null==e?delete this.cache_[t]:this.cache_[t]=e},J.prototype.get=function(t){return N(this.cache_,t)?this.cache_[t]:null},J.prototype.remove=function(t){delete this.cache_[t]},J);function J(){this.cache_={},this.isInMemoryStorage=!0}function Z(t){try{if("undefined"!=typeof window&&void 0!==window[t]){var e=window[t];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new G(e)}}catch(t){}return new $}function tt(t){var e=function(t){for(var e=[],n=0,r=0;r<t.length;r++){var i=t.charCodeAt(r);if(55296<=i&&i<=56319){var o=i-55296;c(++r<t.length,"Surrogate pair missing trail surrogate."),i=65536+(o<<10)+(t.charCodeAt(r)-56320)}i<128?e[n++]=i:(i<2048?e[n++]=i>>6|192:(i<65536?e[n++]=i>>12|224:(e[n++]=i>>18|240,e[n++]=i>>12&63|128),e[n++]=i>>6&63|128),e[n++]=63&i|128)}return e}(t),n=new F;n.update(e);var r=n.digest();return d.encodeByteArray(r)}function et(t,e){c(!e||!0===t||!1===t,"Can't turn on custom loggers persistently."),!0===t?(ft.logLevel=x.VERBOSE,vt=ft.log.bind(ft),e&&dt.set("logging_enabled",!0)):"function"==typeof t?vt=t:(vt=null,dt.remove("logging_enabled"))}function nt(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!0===gt&&(gt=!1,null===vt&&!0===dt.get("logging_enabled")&&et(!0)),vt){var n=yt.apply(null,t);vt(n)}}function rt(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];nt.apply(void 0,a([t],e))}}function it(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE INTERNAL ERROR: "+yt.apply(void 0,a(t));ft.error(n)}function ot(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE FATAL ERROR: "+yt.apply(void 0,a(t));throw ft.error(n),new Error(n)}function st(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="FIREBASE WARNING: "+yt.apply(void 0,a(t));ft.warn(n)}function at(t){return"number"==typeof t&&(t!=t||t===Number.POSITIVE_INFINITY||t===Number.NEGATIVE_INFINITY)}function ht(t,e){return t===e?0:t<e?-1:1}function lt(t,e){if(e&&t in e)return e[t];throw new Error("Missing required key ("+t+") in object: "+T(e))}function ut(t,e){var n=t.length;if(n<=e)return[t];for(var r=[],i=0;i<n;i+=e)n<i+e?r.push(t.substring(i,n)):r.push(t.substring(i,i+e));return r}var ct,pt=Z("localStorage"),dt=Z("sessionStorage"),ft=new j("@firebase/database"),_t=(ct=1,function(){return ct++}),yt=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n="",r=0;r<t.length;r++){var i=t[r];Array.isArray(i)||i&&"object"==typeof i&&"number"==typeof i.length?n+=yt.apply(null,i):n+="object"==typeof i?T(i):i,n+=" "}return n},vt=null,gt=!0,mt="[MIN_NAME]",Ct="[MAX_NAME]",Et=function(t,e){if(t===e)return 0;if(t===mt||e===Ct)return-1;if(e===mt||t===Ct)return 1;var n=Rt(t),r=Rt(e);return null!==n?null!==r?n-r==0?t.length-e.length:n-r:-1:null===r&&t<e?-1:1},wt=function(t){if("object"!=typeof t||null===t)return T(t);var e=[];for(var n in t)e.push(n);e.sort();for(var r="{",i=0;i<e.length;i++)0!==i&&(r+=","),r+=T(e[i]),r+=":",r+=wt(t[e[i]]);return r+"}"};function bt(t,e){for(var n in t)t.hasOwnProperty(n)&&e(n,t[n])}function St(t){var e,n,r,i,o;c(!at(t),"Invalid JSON number"),0===t?e=1/t==-1/(r=n=0)?1:0:(e=t<0,r=(t=Math.abs(t))>=Math.pow(2,-1022)?(n=(i=Math.min(Math.floor(Math.log(t)/Math.LN2),1023))+1023,Math.round(t*Math.pow(2,52-i)-Math.pow(2,52))):(n=0,Math.round(t/Math.pow(2,-1074))));var s=[];for(o=52;o;--o)s.push(r%2?1:0),r=Math.floor(r/2);for(o=11;o;--o)s.push(n%2?1:0),n=Math.floor(n/2);s.push(e?1:0),s.reverse();var a=s.join(""),h="";for(o=0;o<64;o+=8){var l=parseInt(a.substr(o,8),2).toString(16);1===l.length&&(l="0"+l),h+=l}return h.toLowerCase()}function Tt(t){try{t()}catch(e){setTimeout((function(){throw st("Exception was thrown by user callback.",e.stack||""),e}),Math.floor(0))}}function It(t,e){var n=setTimeout(t,e);return"object"==typeof n&&n.unref&&n.unref(),n}var Nt=new RegExp("^-?(0*)\\d{1,10}$"),Rt=function(t){if(Nt.test(t)){var e=Number(t);if(-2147483648<=e&&e<=2147483647)return e}return null},Pt=(Object.defineProperty(Dt,"Empty",{get:function(){return new Dt("")},enumerable:!0,configurable:!0}),Dt.prototype.getFront=function(){return this.pieceNum_>=this.pieces_.length?null:this.pieces_[this.pieceNum_]},Dt.prototype.getLength=function(){return this.pieces_.length-this.pieceNum_},Dt.prototype.popFront=function(){var t=this.pieceNum_;return t<this.pieces_.length&&t++,new Dt(this.pieces_,t)},Dt.prototype.getBack=function(){return this.pieceNum_<this.pieces_.length?this.pieces_[this.pieces_.length-1]:null},Dt.prototype.toString=function(){for(var t="",e=this.pieceNum_;e<this.pieces_.length;e++)""!==this.pieces_[e]&&(t+="/"+this.pieces_[e]);return t||"/"},Dt.prototype.toUrlEncodedString=function(){for(var t="",e=this.pieceNum_;e<this.pieces_.length;e++)""!==this.pieces_[e]&&(t+="/"+encodeURIComponent(String(this.pieces_[e])));return t||"/"},Dt.prototype.slice=function(t){return void 0===t&&(t=0),this.pieces_.slice(this.pieceNum_+t)},Dt.prototype.parent=function(){if(this.pieceNum_>=this.pieces_.length)return null;for(var t=[],e=this.pieceNum_;e<this.pieces_.length-1;e++)t.push(this.pieces_[e]);return new Dt(t,0)},Dt.prototype.child=function(t){for(var e=[],n=this.pieceNum_;n<this.pieces_.length;n++)e.push(this.pieces_[n]);if(t instanceof Dt)for(n=t.pieceNum_;n<t.pieces_.length;n++)e.push(t.pieces_[n]);else{var r=t.split("/");for(n=0;n<r.length;n++)0<r[n].length&&e.push(r[n])}return new Dt(e,0)},Dt.prototype.isEmpty=function(){return this.pieceNum_>=this.pieces_.length},Dt.relativePath=function(t,e){var n=t.getFront(),r=e.getFront();if(null===n)return e;if(n===r)return Dt.relativePath(t.popFront(),e.popFront());throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+t+")")},Dt.comparePaths=function(t,e){for(var n=t.slice(),r=e.slice(),i=0;i<n.length&&i<r.length;i++){var o=Et(n[i],r[i]);if(0!==o)return o}return n.length===r.length?0:n.length<r.length?-1:1},Dt.prototype.equals=function(t){if(this.getLength()!==t.getLength())return!1;for(var e=this.pieceNum_,n=t.pieceNum_;e<=this.pieces_.length;e++,n++)if(this.pieces_[e]!==t.pieces_[n])return!1;return!0},Dt.prototype.contains=function(t){var e=this.pieceNum_,n=t.pieceNum_;if(this.getLength()>t.getLength())return!1;for(;e<this.pieces_.length;){if(this.pieces_[e]!==t.pieces_[n])return!1;++e,++n}return!0},Dt);function Dt(t,e){if(void 0===e){this.pieces_=t.split("/");for(var n=0,r=0;r<this.pieces_.length;r++)0<this.pieces_[r].length&&(this.pieces_[n]=this.pieces_[r],n++);this.pieces_.length=n,this.pieceNum_=0}else this.pieces_=t,this.pieceNum_=e}var Ot=(Object.defineProperty(xt,"MAX_PATH_DEPTH",{get:function(){return 32},enumerable:!0,configurable:!0}),Object.defineProperty(xt,"MAX_PATH_LENGTH_BYTES",{get:function(){return 768},enumerable:!0,configurable:!0}),xt.prototype.push=function(t){0<this.parts_.length&&(this.byteLength_+=1),this.parts_.push(t),this.byteLength_+=q(t),this.checkValid_()},xt.prototype.pop=function(){var t=this.parts_.pop();this.byteLength_-=q(t),0<this.parts_.length&&--this.byteLength_},xt.prototype.checkValid_=function(){if(this.byteLength_>xt.MAX_PATH_LENGTH_BYTES)throw new Error(this.errorPrefix_+"has a key path longer than "+xt.MAX_PATH_LENGTH_BYTES+" bytes ("+this.byteLength_+").");if(this.parts_.length>xt.MAX_PATH_DEPTH)throw new Error(this.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+xt.MAX_PATH_DEPTH+") or object contains a cycle "+this.toErrorString())},xt.prototype.toErrorString=function(){return 0===this.parts_.length?"":"in property '"+this.parts_.join(".")+"'"},xt);function xt(t,e){this.errorPrefix_=e,this.parts_=t.slice(),this.byteLength_=Math.max(1,this.parts_.length);for(var n=0;n<this.parts_.length;n++)this.byteLength_+=q(this.parts_[n]);this.checkValid_()}var kt="firebaseio.com",Ft="websocket",At="long_polling",Lt=(Mt.prototype.needsQueryParam=function(){return this.host!==this.internalHost||this.isCustomHost()||this.includeNamespaceInQueryParams},Mt.prototype.isCacheableHost=function(){return"s-"===this.internalHost.substr(0,2)},Mt.prototype.isDemoHost=function(){return"firebaseio-demo.com"===this.domain},Mt.prototype.isCustomHost=function(){return"firebaseio.com"!==this.domain&&"firebaseio-demo.com"!==this.domain},Mt.prototype.updateHost=function(t){t!==this.internalHost&&(this.internalHost=t,this.isCacheableHost()&&pt.set("host:"+this.host,this.internalHost))},Mt.prototype.connectionURL=function(t,e){var n;if(c("string"==typeof t,"typeof type must == string"),c("object"==typeof e,"typeof params must == object"),t===Ft)n=(this.secure?"wss://":"ws://")+this.internalHost+"/.ws?";else{if(t!==At)throw new Error("Unknown connection type: "+t);n=(this.secure?"https://":"http://")+this.internalHost+"/.lp?"}this.needsQueryParam()&&(e.ns=this.namespace);var r=[];return bt(e,(function(t,e){r.push(t+"="+e)})),n+r.join("&")},Mt.prototype.toString=function(){var t=this.toURLString();return this.persistenceKey&&(t+="<"+this.persistenceKey+">"),t},Mt.prototype.toURLString=function(){return(this.secure?"https://":"http://")+this.host},Mt);function Mt(t,e,n,r,i,o){void 0===i&&(i=""),void 0===o&&(o=!1),this.secure=e,this.namespace=n,this.webSocketOnly=r,this.persistenceKey=i,this.includeNamespaceInQueryParams=o,this.host=t.toLowerCase(),this.domain=this.host.substr(this.host.indexOf(".")+1),this.internalHost=pt.get("host:"+t)||this.host}function Wt(t){var e=Xt(t),n=e.namespace;"firebase.com"===e.domain&&ot(e.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),n&&"undefined"!==n||"localhost"===e.domain||ot("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),e.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&st("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");var r="ws"===e.scheme||"wss"===e.scheme;return{repoInfo:new Lt(e.host,e.secure,n,r,"",n!==e.subdomain),path:new Pt(e.pathString)}}function Qt(t){return"string"==typeof t&&0!==t.length&&!$t.test(t)}function qt(t){return"string"==typeof t&&0!==t.length&&!Jt.test(t)}function Ut(t){return null===t||"string"==typeof t||"number"==typeof t&&!at(t)||t&&"object"==typeof t&&N(t,".sv")}function Vt(t,e,n,r,i){i&&void 0===n||te(M(t,e,i),n,r)}function Ht(t,e,n,r,i){if(!i||void 0!==n){var o=M(t,e,i);if(!n||"object"!=typeof n||Array.isArray(n))throw new Error(o+" must be an object containing the children to replace.");var s=[];bt(n,(function(t,e){var n=new Pt(t);if(te(o,e,r.child(n)),".priority"===n.getBack()&&!Ut(e))throw new Error(o+"contains an invalid value for '"+n.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(n)})),function(t,e){var n,r;for(n=0;n<e.length;n++)for(var i=(r=e[n]).slice(),o=0;o<i.length;o++)if((".priority"!==i[o]||o!==i.length-1)&&!Qt(i[o]))throw new Error(t+"contains an invalid key ("+i[o]+") in path "+r.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');e.sort(Pt.comparePaths);var s=null;for(n=0;n<e.length;n++){if(r=e[n],null!==s&&s.contains(r))throw new Error(t+"contains a path "+s.toString()+" that is ancestor of another path "+r.toString());s=r}}(o,s)}}function Bt(t,e,n,r){if(!r||void 0!==n){if(at(n))throw new Error(M(t,e,r)+"is "+n.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Ut(n))throw new Error(M(t,e,r)+"must be a valid Firebase priority (a string, finite number, server value, or null).")}}function jt(t,e,n,r){if(!r||void 0!==n)switch(n){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(M(t,e,r)+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}function Yt(t,e,n,r){if(!(r&&void 0===n||Qt(n)))throw new Error(M(t,e,r)+'was an invalid key = "'+n+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')}function Kt(t,e,n,r){if(!(r&&void 0===n||qt(n)))throw new Error(M(t,e,r)+'was an invalid path = "'+n+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')}function zt(t,e){if(".info"===e.getFront())throw new Error(t+" failed = Can't modify data under /.info/")}function Gt(t,e,n){var r,i=n.path.toString();if("string"!=typeof n.repoInfo.host||0===n.repoInfo.host.length||!Qt(n.repoInfo.namespace)&&"localhost"!==n.repoInfo.host.split(":")[0]||0!==i.length&&!qt(r=(r=i)&&r.replace(/^\/*\.info(\/|$)/,"/")))throw new Error(M(t,e,!1)+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')}var Xt=function(t){var e="",n="",r="",i="",s="",a=!0,h="https",l=443;if("string"==typeof t){var u=t.indexOf("//");0<=u&&(h=t.substring(0,u-1),t=t.substring(u+2));var c=t.indexOf("/");-1===c&&(c=t.length);var p=t.indexOf("?");-1===p&&(p=t.length),e=t.substring(0,Math.min(c,p)),c<p&&(i=function(t){for(var e="",n=t.split("/"),r=0;r<n.length;r++)if(0<n[r].length){var i=n[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch(t){}e+="/"+i}return e}(t.substring(c,p)));var d=function(t){var e,n,r={};"?"===t.charAt(0)&&(t=t.substring(1));try{for(var i=o(t.split("&")),s=i.next();!s.done;s=i.next()){var a=s.value;if(0!==a.length){var h=a.split("=");2===h.length?r[decodeURIComponent(h[0])]=decodeURIComponent(h[1]):st("Invalid query segment '"+a+"' in query '"+t+"'")}}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r}(t.substring(Math.min(t.length,p)));0<=(u=e.indexOf(":"))?(a="https"===h||"wss"===h,l=parseInt(e.substring(u+1),10)):u=e.length;var f=e.slice(0,u);if("localhost"===f.toLowerCase())n="localhost";else if(f.split(".").length<=2)n=f;else{var _=e.indexOf(".");r=e.substring(0,_).toLowerCase(),n=e.substring(_+1),s=r}"ns"in d&&(s=d.ns)}return{host:e,port:l,domain:n,subdomain:r,secure:a,scheme:h,pathString:i,namespace:s}},$t=/[\[\].#$\/\u0000-\u001F\u007F]/,Jt=/[\[\].#$\u0000-\u001F\u007F]/,Zt=10485760,te=function(t,e,n){var r=n instanceof Pt?new Ot(n,t):n;if(void 0===e)throw new Error(t+"contains undefined "+r.toErrorString());if("function"==typeof e)throw new Error(t+"contains a function "+r.toErrorString()+" with contents = "+e.toString());if(at(e))throw new Error(t+"contains "+e.toString()+" "+r.toErrorString());if("string"==typeof e&&e.length>Zt/3&&q(e)>Zt)throw new Error(t+"contains a string greater than "+Zt+" utf8 bytes "+r.toErrorString()+" ('"+e.substring(0,50)+"...')");if(e&&"object"==typeof e){var i=!1,o=!1;if(bt(e,(function(e,n){if(".value"===e)i=!0;else if(".priority"!==e&&".sv"!==e&&(o=!0,!Qt(e)))throw new Error(t+" contains an invalid key ("+e+") "+r.toErrorString()+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');r.push(e),te(t,n,r),r.pop()})),i&&o)throw new Error(t+' contains ".value" child '+r.toErrorString()+" in addition to actual children.")}},ee=(ne.prototype.cancel=function(t){L("OnDisconnect.cancel",0,1,arguments.length),W("OnDisconnect.cancel",1,t,!0);var e=new f;return this.repo_.onDisconnectCancel(this.path_,e.wrapCallback(t)),e.promise},ne.prototype.remove=function(t){L("OnDisconnect.remove",0,1,arguments.length),zt("OnDisconnect.remove",this.path_),W("OnDisconnect.remove",1,t,!0);var e=new f;return this.repo_.onDisconnectSet(this.path_,null,e.wrapCallback(t)),e.promise},ne.prototype.set=function(t,e){L("OnDisconnect.set",1,2,arguments.length),zt("OnDisconnect.set",this.path_),Vt("OnDisconnect.set",1,t,this.path_,!1),W("OnDisconnect.set",2,e,!0);var n=new f;return this.repo_.onDisconnectSet(this.path_,t,n.wrapCallback(e)),n.promise},ne.prototype.setWithPriority=function(t,e,n){L("OnDisconnect.setWithPriority",2,3,arguments.length),zt("OnDisconnect.setWithPriority",this.path_),Vt("OnDisconnect.setWithPriority",1,t,this.path_,!1),Bt("OnDisconnect.setWithPriority",2,e,!1),W("OnDisconnect.setWithPriority",3,n,!0);var r=new f;return this.repo_.onDisconnectSetWithPriority(this.path_,t,e,r.wrapCallback(n)),r.promise},ne.prototype.update=function(t,e){if(L("OnDisconnect.update",1,2,arguments.length),zt("OnDisconnect.update",this.path_),Array.isArray(t)){for(var n={},r=0;r<t.length;++r)n[""+r]=t[r];t=n,st("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Ht("OnDisconnect.update",1,t,this.path_,!1),W("OnDisconnect.update",2,e,!0);var i=new f;return this.repo_.onDisconnectUpdate(this.path_,t,i.wrapCallback(e)),i.promise},ne);function ne(t,e){this.repo_=t,this.path_=e}var re=(ie.prototype.toJSON=function(){return L("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}},ie);function ie(t,e){this.committed=t,this.snapshot=e}var oe,se,ae,he=(oe="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",se=0,ae=[],function(t){var e,n=t===se;se=t;var r=new Array(8);for(e=7;0<=e;e--)r[e]=oe.charAt(t%64),t=Math.floor(t/64);c(0===t,"Cannot push at time == 0");var i=r.join("");if(n){for(e=11;0<=e&&63===ae[e];e--)ae[e]=0;ae[e]++}else for(e=0;e<12;e++)ae[e]=Math.floor(64*Math.random());for(e=0;e<12;e++)i+=oe.charAt(ae[e]);return c(20===i.length,"nextPushId: Length should be 20."),i}),le=(ue.Wrap=function(t,e){return new ue(t,e)},ue);function ue(t,e){this.name=t,this.node=e}var ce,pe=(de.prototype.getCompare=function(){return this.compare.bind(this)},de.prototype.indexedValueChanged=function(t,e){var n=new le(mt,t),r=new le(mt,e);return 0!==this.compare(n,r)},de.prototype.minPost=function(){return le.MIN},de);function de(){}var fe,_e=(r(ye,fe=pe),Object.defineProperty(ye,"__EMPTY_NODE",{get:function(){return ce},set:function(t){ce=t},enumerable:!0,configurable:!0}),ye.prototype.compare=function(t,e){return Et(t.name,e.name)},ye.prototype.isDefinedOn=function(t){throw p("KeyIndex.isDefinedOn not expected to be called.")},ye.prototype.indexedValueChanged=function(t,e){return!1},ye.prototype.minPost=function(){return le.MIN},ye.prototype.maxPost=function(){return new le(Ct,ce)},ye.prototype.makePost=function(t,e){return c("string"==typeof t,"KeyIndex indexValue must always be a string."),new le(t,ce)},ye.prototype.toString=function(){return".key"},ye);function ye(){return null!==fe&&fe.apply(this,arguments)||this}var ve,ge=new _e;function me(t){return"number"==typeof t?"number:"+St(t):"string:"+t}function Ce(t){if(t.isLeafNode()){var e=t.val();c("string"==typeof e||"number"==typeof e||"object"==typeof e&&N(e,".sv"),"Priority must be a string or number.")}else c(t===ve||t.isEmpty(),"priority of unexpected type.");c(t===ve||t.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")}var Ee,we,be,Se,Te=(Object.defineProperty(Ie,"__childrenNodeConstructor",{get:function(){return Ee},set:function(t){Ee=t},enumerable:!0,configurable:!0}),Ie.prototype.isLeafNode=function(){return!0},Ie.prototype.getPriority=function(){return this.priorityNode_},Ie.prototype.updatePriority=function(t){return new Ie(this.value_,t)},Ie.prototype.getImmediateChild=function(t){return".priority"===t?this.priorityNode_:Ie.__childrenNodeConstructor.EMPTY_NODE},Ie.prototype.getChild=function(t){return t.isEmpty()?this:".priority"===t.getFront()?this.priorityNode_:Ie.__childrenNodeConstructor.EMPTY_NODE},Ie.prototype.hasChild=function(){return!1},Ie.prototype.getPredecessorChildName=function(t,e){return null},Ie.prototype.updateImmediateChild=function(t,e){return".priority"===t?this.updatePriority(e):e.isEmpty()&&".priority"!==t?this:Ie.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,e).updatePriority(this.priorityNode_)},Ie.prototype.updateChild=function(t,e){var n=t.getFront();return null===n?e:e.isEmpty()&&".priority"!==n?this:(c(".priority"!==n||1===t.getLength(),".priority must be the last token in a path"),this.updateImmediateChild(n,Ie.__childrenNodeConstructor.EMPTY_NODE.updateChild(t.popFront(),e)))},Ie.prototype.isEmpty=function(){return!1},Ie.prototype.numChildren=function(){return 0},Ie.prototype.forEachChild=function(t,e){return!1},Ie.prototype.val=function(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()},Ie.prototype.hash=function(){if(null===this.lazyHash_){var t="";this.priorityNode_.isEmpty()||(t+="priority:"+me(this.priorityNode_.val())+":");var e=typeof this.value_;t+=e+":",t+="number"==e?St(this.value_):this.value_,this.lazyHash_=tt(t)}return this.lazyHash_},Ie.prototype.getValue=function(){return this.value_},Ie.prototype.compareTo=function(t){return t===Ie.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof Ie.__childrenNodeConstructor?-1:(c(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))},Ie.prototype.compareToLeafNode_=function(t){var e=typeof t.value_,n=typeof this.value_,r=Ie.VALUE_TYPE_ORDER.indexOf(e),i=Ie.VALUE_TYPE_ORDER.indexOf(n);return c(0<=r,"Unknown leaf type: "+e),c(0<=i,"Unknown leaf type: "+n),r===i?"object"==n?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:i-r},Ie.prototype.withIndex=function(){return this},Ie.prototype.isIndexed=function(){return!0},Ie.prototype.equals=function(t){return t===this||!!t.isLeafNode()&&this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)},Ie.VALUE_TYPE_ORDER=["object","boolean","number","string"],Ie);function Ie(t,e){void 0===e&&(e=Ie.__childrenNodeConstructor.EMPTY_NODE),this.value_=t,this.priorityNode_=e,this.lazyHash_=null,c(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),Ce(this.priorityNode_)}function Ne(){return null!==Se&&Se.apply(this,arguments)||this}var Re=new(r(Ne,Se=pe),Ne.prototype.compare=function(t,e){var n=t.node.getPriority(),r=e.node.getPriority(),i=n.compareTo(r);return 0===i?Et(t.name,e.name):i},Ne.prototype.isDefinedOn=function(t){return!t.getPriority().isEmpty()},Ne.prototype.indexedValueChanged=function(t,e){return!t.getPriority().equals(e.getPriority())},Ne.prototype.minPost=function(){return le.MIN},Ne.prototype.maxPost=function(){return new le(Ct,new Te("[PRIORITY-POST]",be))},Ne.prototype.makePost=function(t,e){var n=we(t);return new le(e,new Te("[PRIORITY-POST]",n))},Ne.prototype.toString=function(){return".priority"},Ne),Pe=(De.prototype.getNext=function(){if(0===this.nodeStack_.length)return null;var t,e=this.nodeStack_.pop();if(t=this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t},De.prototype.hasNext=function(){return 0<this.nodeStack_.length},De.prototype.peek=function(){if(0===this.nodeStack_.length)return null;var t=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value}},De);function De(t,e,n,r,i){void 0===i&&(i=null),this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];for(var o=1;!t.isEmpty();)if(t=t,o=e?n(t.key,e):1,r&&(o*=-1),o<0)t=this.isReverse_?t.left:t.right;else{if(0===o){this.nodeStack_.push(t);break}this.nodeStack_.push(t),t=this.isReverse_?t.right:t.left}}var Oe=(xe.prototype.copy=function(t,e,n,r,i){return new xe(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)},xe.prototype.count=function(){return this.left.count()+1+this.right.count()},xe.prototype.isEmpty=function(){return!1},xe.prototype.inorderTraversal=function(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)},xe.prototype.reverseTraversal=function(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)},xe.prototype.min_=function(){return this.left.isEmpty()?this:this.left.min_()},xe.prototype.minKey=function(){return this.min_().key},xe.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},xe.prototype.insert=function(t,e,n){var r=this,i=n(t,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===i?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp_()},xe.prototype.removeMin_=function(){if(this.left.isEmpty())return Ae.EMPTY_NODE;var t=this;return t.left.isRed_()||t.left.left.isRed_()||(t=t.moveRedLeft_()),(t=t.copy(null,null,null,t.left.removeMin_(),null)).fixUp_()},xe.prototype.remove=function(t,e){var n,r;if(e(t,(n=this).key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(t,e),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===e(t,n.key)){if(n.right.isEmpty())return Ae.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(t,e))}return n.fixUp_()},xe.prototype.isRed_=function(){return this.color},xe.prototype.fixUp_=function(){var t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t},xe.prototype.moveRedLeft_=function(){var t=this.colorFlip_();return t.right.left.isRed_()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight_())).rotateLeft_()).colorFlip_()),t},xe.prototype.moveRedRight_=function(){var t=this.colorFlip_();return t.left.left.isRed_()&&(t=(t=t.rotateRight_()).colorFlip_()),t},xe.prototype.rotateLeft_=function(){var t=this.copy(null,null,xe.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)},xe.prototype.rotateRight_=function(){var t=this.copy(null,null,xe.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)},xe.prototype.colorFlip_=function(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)},xe.prototype.checkMaxDepth_=function(){var t=this.check_();return Math.pow(2,t)<=this.count()+1},xe.prototype.check_=function(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");var t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)},xe.RED=!0,xe.BLACK=!1,xe);function xe(t,e,n,r,i){this.key=t,this.value=e,this.color=null!=n?n:xe.RED,this.left=null!=r?r:Ae.EMPTY_NODE,this.right=null!=i?i:Ae.EMPTY_NODE}var ke=(Fe.prototype.copy=function(t,e,n,r,i){return this},Fe.prototype.insert=function(t,e,n){return new Oe(t,e,null)},Fe.prototype.remove=function(t,e){return this},Fe.prototype.count=function(){return 0},Fe.prototype.isEmpty=function(){return!0},Fe.prototype.inorderTraversal=function(t){return!1},Fe.prototype.reverseTraversal=function(t){return!1},Fe.prototype.minKey=function(){return null},Fe.prototype.maxKey=function(){return null},Fe.prototype.check_=function(){return 0},Fe.prototype.isRed_=function(){return!1},Fe);function Fe(){}var Ae=(Le.prototype.insert=function(t,e){return new Le(this.comparator_,this.root_.insert(t,e,this.comparator_).copy(null,null,Oe.BLACK,null,null))},Le.prototype.remove=function(t){return new Le(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,Oe.BLACK,null,null))},Le.prototype.get=function(t){for(var e,n=this.root_;!n.isEmpty();){if(0===(e=this.comparator_(t,n.key)))return n.value;e<0?n=n.left:0<e&&(n=n.right)}return null},Le.prototype.getPredecessorKey=function(t){for(var e,n=this.root_,r=null;!n.isEmpty();){if(0===(e=this.comparator_(t,n.key))){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}e<0?n=n.left:0<e&&(n=(r=n).right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")},Le.prototype.isEmpty=function(){return this.root_.isEmpty()},Le.prototype.count=function(){return this.root_.count()},Le.prototype.minKey=function(){return this.root_.minKey()},Le.prototype.maxKey=function(){return this.root_.maxKey()},Le.prototype.inorderTraversal=function(t){return this.root_.inorderTraversal(t)},Le.prototype.reverseTraversal=function(t){return this.root_.reverseTraversal(t)},Le.prototype.getIterator=function(t){return new Pe(this.root_,null,this.comparator_,!1,t)},Le.prototype.getIteratorFrom=function(t,e){return new Pe(this.root_,t,this.comparator_,!1,e)},Le.prototype.getReverseIteratorFrom=function(t,e){return new Pe(this.root_,t,this.comparator_,!0,e)},Le.prototype.getReverseIterator=function(t){return new Pe(this.root_,null,this.comparator_,!0,t)},Le.EMPTY_NODE=new ke,Le);function Le(t,e){void 0===e&&(e=Le.EMPTY_NODE),this.comparator_=t,this.root_=e}var Me=Math.log(2),We=(Qe.prototype.nextBitIsOne=function(){var t=!(this.bits_&1<<this.current_);return this.current_--,t},Qe);function Qe(t){var e;this.count=(e=t+1,parseInt(Math.log(e)/Me,10)),this.current_=this.count-1;var n,r=(n=this.count,parseInt(Array(n+1).join("1"),2));this.bits_=t+1&r}var qe,Ue,Ve=function(t,e,n,r){t.sort(e);var i=function(e,r){var o,s,a=r-e;if(0==a)return null;if(1==a)return o=t[e],s=n?n(o):o,new Oe(s,o.node,Oe.BLACK,null,null);var h=parseInt(a/2,10)+e,l=i(e,h),u=i(h+1,r);return o=t[h],s=n?n(o):o,new Oe(s,o.node,Oe.BLACK,l,u)},o=function(e){for(var r=null,o=null,s=t.length,a=function(e,r){var o=s-e,a=s;s-=e;var l=i(1+o,a),u=t[o],c=n?n(u):u;h(new Oe(c,u.node,r,null,l))},h=function(t){r=r?r.left=t:o=t},l=0;l<e.count;++l){var u=e.nextBitIsOne(),c=Math.pow(2,e.count-(l+1));u?a(c,Oe.BLACK):(a(c,Oe.BLACK),a(c,Oe.RED))}return o}(new We(t.length));return new Ae(r||e,o)},He={},Be=(Object.defineProperty(je,"Default",{get:function(){return c(Re,"ChildrenNode.ts has not been loaded"),qe=qe||new je({".priority":He},{".priority":Re})},enumerable:!0,configurable:!0}),je.prototype.get=function(t){var e=R(this.indexes_,t);if(!e)throw new Error("No index defined for "+t);return e instanceof Ae?e:null},je.prototype.hasIndex=function(t){return N(this.indexSet_,t.toString())},je.prototype.addIndex=function(t,e){c(t!==ge,"KeyIndex always exists and isn't meant to be added to the IndexMap.");for(var n,r=[],o=!1,s=e.getIterator(le.Wrap),a=s.getNext();a;)o=o||t.isDefinedOn(a.node),r.push(a),a=s.getNext();n=o?Ve(r,t.getCompare()):He;var h=t.toString(),l=i({},this.indexSet_);l[h]=t;var u=i({},this.indexes_);return u[h]=n,new je(u,l)},je.prototype.addToIndexes=function(t,e){var n=this;return new je(D(this.indexes_,(function(r,i){var o=R(n.indexSet_,i);if(c(o,"Missing index implementation for "+i),r===He){if(o.isDefinedOn(t.node)){for(var s=[],a=e.getIterator(le.Wrap),h=a.getNext();h;)h.name!==t.name&&s.push(h),h=a.getNext();return s.push(t),Ve(s,o.getCompare())}return He}var l=e.get(t.name),u=r;return l&&(u=u.remove(new le(t.name,l))),u.insert(t,t.node)})),this.indexSet_)},je.prototype.removeFromIndexes=function(t,e){return new je(D(this.indexes_,(function(n){if(n===He)return n;var r=e.get(t.name);return r?n.remove(new le(t.name,r)):n})),this.indexSet_)},je);function je(t,e){this.indexes_=t,this.indexSet_=e}function Ye(t,e){return Et(t.name,e.name)}function Ke(t,e){return Et(t,e)}var ze,Ge=(Object.defineProperty(Xe,"EMPTY_NODE",{get:function(){return Ue=Ue||new Xe(new Ae(Ke),null,Be.Default)},enumerable:!0,configurable:!0}),Xe.prototype.isLeafNode=function(){return!1},Xe.prototype.getPriority=function(){return this.priorityNode_||Ue},Xe.prototype.updatePriority=function(t){return this.children_.isEmpty()?this:new Xe(this.children_,t,this.indexMap_)},Xe.prototype.getImmediateChild=function(t){if(".priority"===t)return this.getPriority();var e=this.children_.get(t);return null===e?Ue:e},Xe.prototype.getChild=function(t){var e=t.getFront();return null===e?this:this.getImmediateChild(e).getChild(t.popFront())},Xe.prototype.hasChild=function(t){return null!==this.children_.get(t)},Xe.prototype.updateImmediateChild=function(t,e){if(c(e,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(e);var n,r=new le(t,e),i=void 0;n=e.isEmpty()?(i=this.children_.remove(t),this.indexMap_.removeFromIndexes(r,this.children_)):(i=this.children_.insert(t,e),this.indexMap_.addToIndexes(r,this.children_));var o=i.isEmpty()?Ue:this.priorityNode_;return new Xe(i,o,n)},Xe.prototype.updateChild=function(t,e){var n=t.getFront();if(null===n)return e;c(".priority"!==t.getFront()||1===t.getLength(),".priority must be the last token in a path");var r=this.getImmediateChild(n).updateChild(t.popFront(),e);return this.updateImmediateChild(n,r)},Xe.prototype.isEmpty=function(){return this.children_.isEmpty()},Xe.prototype.numChildren=function(){return this.children_.count()},Xe.prototype.val=function(t){if(this.isEmpty())return null;var e={},n=0,r=0,i=!0;if(this.forEachChild(Re,(function(o,s){e[o]=s.val(t),n++,i&&Xe.INTEGER_REGEXP_.test(o)?r=Math.max(r,Number(o)):i=!1})),!t&&i&&r<2*n){var o=[];for(var s in e)o[s]=e[s];return o}return t&&!this.getPriority().isEmpty()&&(e[".priority"]=this.getPriority().val()),e},Xe.prototype.hash=function(){if(null===this.lazyHash_){var t="";this.getPriority().isEmpty()||(t+="priority:"+me(this.getPriority().val())+":"),this.forEachChild(Re,(function(e,n){var r=n.hash();""!==r&&(t+=":"+e+":"+r)})),this.lazyHash_=""===t?"":tt(t)}return this.lazyHash_},Xe.prototype.getPredecessorChildName=function(t,e,n){var r=this.resolveIndex_(n);if(r){var i=r.getPredecessorKey(new le(t,e));return i?i.name:null}return this.children_.getPredecessorKey(t)},Xe.prototype.getFirstChildName=function(t){var e=this.resolveIndex_(t);if(e){var n=e.minKey();return n&&n.name}return this.children_.minKey()},Xe.prototype.getFirstChild=function(t){var e=this.getFirstChildName(t);return e?new le(e,this.children_.get(e)):null},Xe.prototype.getLastChildName=function(t){var e=this.resolveIndex_(t);if(e){var n=e.maxKey();return n&&n.name}return this.children_.maxKey()},Xe.prototype.getLastChild=function(t){var e=this.getLastChildName(t);return e?new le(e,this.children_.get(e)):null},Xe.prototype.forEachChild=function(t,e){var n=this.resolveIndex_(t);return n?n.inorderTraversal((function(t){return e(t.name,t.node)})):this.children_.inorderTraversal(e)},Xe.prototype.getIterator=function(t){return this.getIteratorFrom(t.minPost(),t)},Xe.prototype.getIteratorFrom=function(t,e){var n=this.resolveIndex_(e);if(n)return n.getIteratorFrom(t,(function(t){return t}));for(var r=this.children_.getIteratorFrom(t.name,le.Wrap),i=r.peek();null!=i&&e.compare(i,t)<0;)r.getNext(),i=r.peek();return r},Xe.prototype.getReverseIterator=function(t){return this.getReverseIteratorFrom(t.maxPost(),t)},Xe.prototype.getReverseIteratorFrom=function(t,e){var n=this.resolveIndex_(e);if(n)return n.getReverseIteratorFrom(t,(function(t){return t}));for(var r=this.children_.getReverseIteratorFrom(t.name,le.Wrap),i=r.peek();null!=i&&0<e.compare(i,t);)r.getNext(),i=r.peek();return r},Xe.prototype.compareTo=function(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===Je?-1:0},Xe.prototype.withIndex=function(t){if(t===ge||this.indexMap_.hasIndex(t))return this;var e=this.indexMap_.addIndex(t,this.children_);return new Xe(this.children_,this.priorityNode_,e)},Xe.prototype.isIndexed=function(t){return t===ge||this.indexMap_.hasIndex(t)},Xe.prototype.equals=function(t){if(t===this)return!0;if(t.isLeafNode())return!1;var e=t;if(this.getPriority().equals(e.getPriority())){if(this.children_.count()!==e.children_.count())return!1;for(var n=this.getIterator(Re),r=e.getIterator(Re),i=n.getNext(),o=r.getNext();i&&o;){if(i.name!==o.name||!i.node.equals(o.node))return!1;i=n.getNext(),o=r.getNext()}return null===i&&null===o}return!1},Xe.prototype.resolveIndex_=function(t){return t===ge?null:this.indexMap_.get(t.toString())},Xe.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,Xe);function Xe(t,e,n){this.children_=t,this.priorityNode_=e,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&Ce(this.priorityNode_),this.children_.isEmpty()&&c(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}function $e(){return ze.call(this,new Ae(Ke),Ge.EMPTY_NODE,Be.Default)||this}var Je=new(r($e,ze=Ge),$e.prototype.compareTo=function(t){return t===this?0:1},$e.prototype.equals=function(t){return t===this},$e.prototype.getPriority=function(){return this},$e.prototype.getImmediateChild=function(t){return Ge.EMPTY_NODE},$e.prototype.isEmpty=function(){return!1},$e);Object.defineProperties(le,{MIN:{value:new le(mt,Ge.EMPTY_NODE)},MAX:{value:new le(Ct,Je)}}),_e.__EMPTY_NODE=Ge.EMPTY_NODE,Te.__childrenNodeConstructor=Ge,ve=Je,be=Je;var Ze,tn=!0;function en(t,e){if(void 0===e&&(e=null),null===t)return Ge.EMPTY_NODE;if("object"==typeof t&&".priority"in t&&(e=t[".priority"]),c(null===e||"string"==typeof e||"number"==typeof e||"object"==typeof e&&".sv"in e,"Invalid priority type found: "+typeof e),"object"==typeof t&&".value"in t&&null!==t[".value"]&&(t=t[".value"]),"object"!=typeof t||".sv"in t)return new Te(t,en(e));if(t instanceof Array||!tn){var n=Ge.EMPTY_NODE;return bt(t,(function(e,r){if(N(t,e)&&"."!==e.substring(0,1)){var i=en(r);!i.isLeafNode()&&i.isEmpty()||(n=n.updateImmediateChild(e,i))}})),n.updatePriority(en(e))}var r=[],i=!1;if(bt(t,(function(t,e){if("."!==t.substring(0,1)){var n=en(e);n.isEmpty()||(i=i||!n.getPriority().isEmpty(),r.push(new le(t,n)))}})),0===r.length)return Ge.EMPTY_NODE;var o=Ve(r,Ye,(function(t){return t.name}),Ke);if(i){var s=Ve(r,Re.getCompare());return new Ge(o,en(e),new Be({".priority":s},{".priority":Re}))}return new Ge(o,en(e),Be.Default)}function nn(){return null!==Ze&&Ze.apply(this,arguments)||this}we=en;var rn,on=new(r(nn,Ze=pe),nn.prototype.compare=function(t,e){var n=t.node.compareTo(e.node);return 0===n?Et(t.name,e.name):n},nn.prototype.isDefinedOn=function(t){return!0},nn.prototype.indexedValueChanged=function(t,e){return!t.equals(e)},nn.prototype.minPost=function(){return le.MIN},nn.prototype.maxPost=function(){return le.MAX},nn.prototype.makePost=function(t,e){var n=en(t);return new le(e,n)},nn.prototype.toString=function(){return".value"},nn),sn=(r(an,rn=pe),an.prototype.extractChild=function(t){return t.getChild(this.indexPath_)},an.prototype.isDefinedOn=function(t){return!t.getChild(this.indexPath_).isEmpty()},an.prototype.compare=function(t,e){var n=this.extractChild(t.node),r=this.extractChild(e.node),i=n.compareTo(r);return 0===i?Et(t.name,e.name):i},an.prototype.makePost=function(t,e){var n=en(t),r=Ge.EMPTY_NODE.updateChild(this.indexPath_,n);return new le(e,r)},an.prototype.maxPost=function(){var t=Ge.EMPTY_NODE.updateChild(this.indexPath_,Je);return new le(Ct,t)},an.prototype.toString=function(){return this.indexPath_.slice().join("/")},an);function an(t){var e=rn.call(this)||this;return e.indexPath_=t,c(!t.isEmpty()&&".priority"!==t.getFront(),"Can't create PathIndex with empty path or .priority key"),e}var hn=(ln.prototype.val=function(){return L("DataSnapshot.val",0,0,arguments.length),this.node_.val()},ln.prototype.exportVal=function(){return L("DataSnapshot.exportVal",0,0,arguments.length),this.node_.val(!0)},ln.prototype.toJSON=function(){return L("DataSnapshot.toJSON",0,1,arguments.length),this.exportVal()},ln.prototype.exists=function(){return L("DataSnapshot.exists",0,0,arguments.length),!this.node_.isEmpty()},ln.prototype.child=function(t){L("DataSnapshot.child",0,1,arguments.length),Kt("DataSnapshot.child",1,t=String(t),!1);var e=new Pt(t),n=this.ref_.child(e);return new ln(this.node_.getChild(e),n,Re)},ln.prototype.hasChild=function(t){L("DataSnapshot.hasChild",1,1,arguments.length),Kt("DataSnapshot.hasChild",1,t,!1);var e=new Pt(t);return!this.node_.getChild(e).isEmpty()},ln.prototype.getPriority=function(){return L("DataSnapshot.getPriority",0,0,arguments.length),this.node_.getPriority().val()},ln.prototype.forEach=function(t){var e=this;return L("DataSnapshot.forEach",1,1,arguments.length),W("DataSnapshot.forEach",1,t,!1),!this.node_.isLeafNode()&&!!this.node_.forEachChild(this.index_,(function(n,r){return t(new ln(r,e.ref_.child(n),Re))}))},ln.prototype.hasChildren=function(){return L("DataSnapshot.hasChildren",0,0,arguments.length),!this.node_.isLeafNode()&&!this.node_.isEmpty()},Object.defineProperty(ln.prototype,"key",{get:function(){return this.ref_.getKey()},enumerable:!0,configurable:!0}),ln.prototype.numChildren=function(){return L("DataSnapshot.numChildren",0,0,arguments.length),this.node_.numChildren()},ln.prototype.getRef=function(){return L("DataSnapshot.ref",0,0,arguments.length),this.ref_},Object.defineProperty(ln.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),ln);function ln(t,e,n){this.node_=t,this.ref_=e,this.index_=n}var un=(cn.prototype.getPath=function(){var t=this.snapshot.getRef();return"value"===this.eventType?t.path:t.getParent().path},cn.prototype.getEventType=function(){return this.eventType},cn.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},cn.prototype.toString=function(){return this.getPath().toString()+":"+this.eventType+":"+T(this.snapshot.exportVal())},cn);function cn(t,e,n,r){this.eventType=t,this.eventRegistration=e,this.snapshot=n,this.prevName=r}var pn=(dn.prototype.getPath=function(){return this.path},dn.prototype.getEventType=function(){return"cancel"},dn.prototype.getEventRunner=function(){return this.eventRegistration.getEventRunner(this)},dn.prototype.toString=function(){return this.path.toString()+":cancel"},dn);function dn(t,e,n){this.eventRegistration=t,this.error=e,this.path=n}var fn=(_n.prototype.respondsTo=function(t){return"value"===t},_n.prototype.createEvent=function(t,e){var n=e.getQueryParams().getIndex();return new un("value",this,new hn(t.snapshotNode,e.getRef(),n))},_n.prototype.getEventRunner=function(t){var e=this.context_;if("cancel"===t.getEventType()){c(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(e,t.error)}}var r=this.callback_;return function(){r.call(e,t.snapshot)}},_n.prototype.createCancelEvent=function(t,e){return this.cancelCallback_?new pn(this,t,e):null},_n.prototype.matches=function(t){return t instanceof _n&&(!t.callback_||!this.callback_||t.callback_===this.callback_&&t.context_===this.context_)},_n.prototype.hasAnyCallback=function(){return null!==this.callback_},_n);function _n(t,e,n){this.callback_=t,this.cancelCallback_=e,this.context_=n}var yn,vn=(gn.prototype.respondsTo=function(t){var e="children_added"===t?"child_added":t;return e="children_removed"===e?"child_removed":e,N(this.callbacks_,e)},gn.prototype.createCancelEvent=function(t,e){return this.cancelCallback_?new pn(this,t,e):null},gn.prototype.createEvent=function(t,e){c(null!=t.childName,"Child events should have a childName.");var n=e.getRef().child(t.childName),r=e.getQueryParams().getIndex();return new un(t.type,this,new hn(t.snapshotNode,n,r),t.prevName)},gn.prototype.getEventRunner=function(t){var e=this.context_;if("cancel"===t.getEventType()){c(this.cancelCallback_,"Raising a cancel event on a listener with no cancel callback");var n=this.cancelCallback_;return function(){n.call(e,t.error)}}var r=this.callbacks_[t.eventType];return function(){r.call(e,t.snapshot,t.prevName)}},gn.prototype.matches=function(t){var e=this;if(t instanceof gn){if(!this.callbacks_||!t.callbacks_)return!0;if(this.context_===t.context_){var n=Object.keys(t.callbacks_),r=Object.keys(this.callbacks_),i=n.length;if(i===r.length){if(1!==i)return r.every((function(n){return t.callbacks_[n]===e.callbacks_[n]}));var o=n[0],s=r[0];return!(s!==o||t.callbacks_[o]&&this.callbacks_[s]&&t.callbacks_[o]!==this.callbacks_[s])}}}return!1},gn.prototype.hasAnyCallback=function(){return null!==this.callbacks_},gn);function gn(t,e,n){this.callbacks_=t,this.cancelCallback_=e,this.context_=n}var mn=(Object.defineProperty(Cn,"__referenceConstructor",{get:function(){return c(yn,"Reference.ts has not been loaded"),yn},set:function(t){yn=t},enumerable:!0,configurable:!0}),Cn.validateQueryEndpoints_=function(t){var e=null,n=null;if(t.hasStart()&&(e=t.getIndexStartValue()),t.hasEnd()&&(n=t.getIndexEndValue()),t.getIndex()===ge){var r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), endAt(),or equalTo() must be a string.";if(t.hasStart()){if(t.getIndexStartName()!==mt)throw new Error(r);if("string"!=typeof e)throw new Error(i)}if(t.hasEnd()){if(t.getIndexEndName()!==Ct)throw new Error(r);if("string"!=typeof n)throw new Error(i)}}else if(t.getIndex()===Re){if(null!=e&&!Ut(e)||null!=n&&!Ut(n))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), endAt(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(c(t.getIndex()instanceof sn||t.getIndex()===on,"unknown index type."),null!=e&&"object"==typeof e||null!=n&&"object"==typeof n)throw new Error("Query: First argument passed to startAt(), endAt(), or equalTo() cannot be an object.")},Cn.validateLimit_=function(t){if(t.hasStart()&&t.hasEnd()&&t.hasLimit()&&!t.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), endAt(), and limit(). Use limitToFirst() or limitToLast() instead.")},Cn.prototype.validateNoPreviousOrderByCall_=function(t){if(!0===this.orderByCalled_)throw new Error(t+": You can't combine multiple orderBy calls.")},Cn.prototype.getQueryParams=function(){return this.queryParams_},Cn.prototype.getRef=function(){return L("Query.ref",0,0,arguments.length),new Cn.__referenceConstructor(this.repo,this.path)},Cn.prototype.on=function(t,e,n,r){L("Query.on",2,4,arguments.length),jt("Query.on",1,t,!1),W("Query.on",2,e,!1);var i=Cn.getCancelAndContextArgs_("Query.on",n,r);if("value"===t)this.onValueEvent(e,i.cancel,i.context);else{var o={};o[t]=e,this.onChildEvent(o,i.cancel,i.context)}return e},Cn.prototype.onValueEvent=function(t,e,n){var r=new fn(t,e||null,n||null);this.repo.addEventCallbackForQuery(this,r)},Cn.prototype.onChildEvent=function(t,e,n){var r=new vn(t,e,n);this.repo.addEventCallbackForQuery(this,r)},Cn.prototype.off=function(t,e,n){L("Query.off",0,3,arguments.length),jt("Query.off",1,t,!0),W("Query.off",2,e,!0),Q("Query.off",3,n,!0);var r=null,i=null;"value"===t?r=new fn(e||null,null,n||null):t&&(e&&((i={})[t]=e),r=new vn(i,null,n||null)),this.repo.removeEventCallbackForQuery(this,r)},Cn.prototype.once=function(t,e,n,r){var i=this;L("Query.once",1,4,arguments.length),jt("Query.once",1,t,!1),W("Query.once",2,e,!0);var o=Cn.getCancelAndContextArgs_("Query.once",n,r),s=!0,a=new f;a.promise.catch((function(){}));var h=function(n){s&&(s=!1,i.off(t,h),e&&e.bind(o.context)(n),a.resolve(n))};return this.on(t,h,(function(e){i.off(t,h),o.cancel&&o.cancel.bind(o.context)(e),a.reject(e)})),a.promise},Cn.prototype.limitToFirst=function(t){if(L("Query.limitToFirst",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToFirst: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToFirst: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Cn(this.repo,this.path,this.queryParams_.limitToFirst(t),this.orderByCalled_)},Cn.prototype.limitToLast=function(t){if(L("Query.limitToLast",1,1,arguments.length),"number"!=typeof t||Math.floor(t)!==t||t<=0)throw new Error("Query.limitToLast: First argument must be a positive integer.");if(this.queryParams_.hasLimit())throw new Error("Query.limitToLast: Limit was already set (by another call to limit, limitToFirst, or limitToLast).");return new Cn(this.repo,this.path,this.queryParams_.limitToLast(t),this.orderByCalled_)},Cn.prototype.orderByChild=function(t){if(L("Query.orderByChild",1,1,arguments.length),"$key"===t)throw new Error('Query.orderByChild: "$key" is invalid.  Use Query.orderByKey() instead.');if("$priority"===t)throw new Error('Query.orderByChild: "$priority" is invalid.  Use Query.orderByPriority() instead.');if("$value"===t)throw new Error('Query.orderByChild: "$value" is invalid.  Use Query.orderByValue() instead.');Kt("Query.orderByChild",1,t,!1),this.validateNoPreviousOrderByCall_("Query.orderByChild");var e=new Pt(t);if(e.isEmpty())throw new Error("Query.orderByChild: cannot pass in empty path.  Use Query.orderByValue() instead.");var n=new sn(e),r=this.queryParams_.orderBy(n);return Cn.validateQueryEndpoints_(r),new Cn(this.repo,this.path,r,!0)},Cn.prototype.orderByKey=function(){L("Query.orderByKey",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByKey");var t=this.queryParams_.orderBy(ge);return Cn.validateQueryEndpoints_(t),new Cn(this.repo,this.path,t,!0)},Cn.prototype.orderByPriority=function(){L("Query.orderByPriority",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByPriority");var t=this.queryParams_.orderBy(Re);return Cn.validateQueryEndpoints_(t),new Cn(this.repo,this.path,t,!0)},Cn.prototype.orderByValue=function(){L("Query.orderByValue",0,0,arguments.length),this.validateNoPreviousOrderByCall_("Query.orderByValue");var t=this.queryParams_.orderBy(on);return Cn.validateQueryEndpoints_(t),new Cn(this.repo,this.path,t,!0)},Cn.prototype.startAt=function(t,e){void 0===t&&(t=null),L("Query.startAt",0,2,arguments.length),Vt("Query.startAt",1,t,this.path,!0),Yt("Query.startAt",2,e,!0);var n=this.queryParams_.startAt(t,e);if(Cn.validateLimit_(n),Cn.validateQueryEndpoints_(n),this.queryParams_.hasStart())throw new Error("Query.startAt: Starting point was already set (by another call to startAt or equalTo).");return void 0===t&&(e=t=null),new Cn(this.repo,this.path,n,this.orderByCalled_)},Cn.prototype.endAt=function(t,e){void 0===t&&(t=null),L("Query.endAt",0,2,arguments.length),Vt("Query.endAt",1,t,this.path,!0),Yt("Query.endAt",2,e,!0);var n=this.queryParams_.endAt(t,e);if(Cn.validateLimit_(n),Cn.validateQueryEndpoints_(n),this.queryParams_.hasEnd())throw new Error("Query.endAt: Ending point was already set (by another call to endAt or equalTo).");return new Cn(this.repo,this.path,n,this.orderByCalled_)},Cn.prototype.equalTo=function(t,e){if(L("Query.equalTo",1,2,arguments.length),Vt("Query.equalTo",1,t,this.path,!1),Yt("Query.equalTo",2,e,!0),this.queryParams_.hasStart())throw new Error("Query.equalTo: Starting point was already set (by another call to startAt or equalTo).");if(this.queryParams_.hasEnd())throw new Error("Query.equalTo: Ending point was already set (by another call to endAt or equalTo).");return this.startAt(t,e).endAt(t,e)},Cn.prototype.toString=function(){return L("Query.toString",0,0,arguments.length),this.repo.toString()+this.path.toUrlEncodedString()},Cn.prototype.toJSON=function(){return L("Query.toJSON",0,1,arguments.length),this.toString()},Cn.prototype.queryObject=function(){return this.queryParams_.getQueryObject()},Cn.prototype.queryIdentifier=function(){var t=this.queryObject(),e=wt(t);return"{}"===e?"default":e},Cn.prototype.isEqual=function(t){if(L("Query.isEqual",1,1,arguments.length),!(t instanceof Cn))throw new Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.");var e=this.repo===t.repo,n=this.path.equals(t.path),r=this.queryIdentifier()===t.queryIdentifier();return e&&n&&r},Cn.getCancelAndContextArgs_=function(t,e,n){var r={cancel:null,context:null};if(e&&n)r.cancel=e,W(t,3,r.cancel,!0),r.context=n,Q(t,4,r.context,!0);else if(e)if("object"==typeof e&&null!==e)r.context=e;else{if("function"!=typeof e)throw new Error(M(t,3,!0)+" must either be a cancel callback or a context object.");r.cancel=e}return r},Object.defineProperty(Cn.prototype,"ref",{get:function(){return this.getRef()},enumerable:!0,configurable:!0}),Cn);function Cn(t,e,n,r){this.repo=t,this.path=e,this.queryParams_=n,this.orderByCalled_=r}var En=(wn.prototype.getImmediateChild=function(t){return new wn(this.node_.getImmediateChild(t))},wn.prototype.node=function(){return this.node_},wn);function wn(t){this.node_=t}var bn=(Sn.prototype.getImmediateChild=function(t){var e=this.path_.child(t);return new Sn(this.syncTree_,e)},Sn.prototype.node=function(){return this.syncTree_.calcCompleteEventCache(this.path_)},Sn);function Sn(t,e){this.syncTree_=t,this.path_=e}function Tn(t,e,n,r){return Dn(e,new bn(n,t),r)}function In(t,e,n){return Dn(t,new En(e),n)}var Nn=function(t,e,n){return t&&"object"==typeof t?(c(".sv"in t,"Unexpected leaf node or priority contents"),"string"==typeof t[".sv"]?Rn(t[".sv"],e,n):"object"==typeof t[".sv"]?Pn(t[".sv"],e):void c(!1,"Unexpected server value: "+JSON.stringify(t,null,2))):t},Rn=function(t,e,n){switch(t){case"timestamp":return n.timestamp;default:c(!1,"Unexpected server value: "+t)}},Pn=function(t,e,n){t.hasOwnProperty("increment")||c(!1,"Unexpected server value: "+JSON.stringify(t,null,2));var r=t.increment;"number"!=typeof r&&c(!1,"Unexpected increment value: "+r);var i=e.node();if(c(null!=i,"Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;var o=i.getValue();return"number"!=typeof o?r:o+r};function Dn(t,e,n){var r,i=t.getPriority().val(),o=Nn(i,e.getImmediateChild(".priority"),n);if(t.isLeafNode()){var s=t,a=Nn(s.getValue(),e,n);return a!==s.getValue()||o!==s.getPriority().val()?new Te(a,en(o)):t}var h=t;return o!==(r=h).getPriority().val()&&(r=r.updatePriority(new Te(o))),h.forEachChild(Re,(function(t,i){var o=Dn(i,e.getImmediateChild(t),n);o!==i&&(r=r.updateImmediateChild(t,o))})),r}var On,xn,kn=(Fn.prototype.find=function(t){if(null!=this.value)return this.value.getChild(t);if(!t.isEmpty()&&0<this.children.size){var e=t.getFront();return t=t.popFront(),this.children.has(e)?this.children.get(e).find(t):null}return null},Fn.prototype.remember=function(t,e){if(t.isEmpty())this.value=e,this.children.clear();else if(null!==this.value)this.value=this.value.updateChild(t,e);else{var n=t.getFront();this.children.has(n)||this.children.set(n,new Fn);var r=this.children.get(n);t=t.popFront(),r.remember(t,e)}},Fn.prototype.forget=function(t){if(t.isEmpty())return this.value=null,this.children.clear(),!0;if(null!==this.value){if(this.value.isLeafNode())return!1;var e=this.value;this.value=null;var n=this;return e.forEachChild(Re,(function(t,e){n.remember(new Pt(t),e)})),this.forget(t)}if(0<this.children.size){var r=t.getFront();return t=t.popFront(),!this.children.has(r)||this.children.get(r).forget(t)&&this.children.delete(r),0===this.children.size}return!0},Fn.prototype.forEachTree=function(t,e){null!==this.value?e(t,this.value):this.forEachChild((function(n,r){var i=new Pt(t.toString()+"/"+n);r.forEachTree(i,e)}))},Fn.prototype.forEachChild=function(t){this.children.forEach((function(e,n){t(n,e)}))},Fn);function Fn(){this.value=null,this.children=new Map}(xn=On=On||{})[xn.OVERWRITE=0]="OVERWRITE",xn[xn.MERGE=1]="MERGE",xn[xn.ACK_USER_WRITE=2]="ACK_USER_WRITE",xn[xn.LISTEN_COMPLETE=3]="LISTEN_COMPLETE";var An=(Ln.User=new Ln(!0,!1,null,!1),Ln.Server=new Ln(!1,!0,null,!1),Ln.forServerTaggedQuery=function(t){return new Ln(!1,!0,t,!0)},Ln);function Ln(t,e,n,r){this.fromUser=t,this.fromServer=e,this.queryId=n,this.tagged=r,c(!r||e,"Tagged queries must be from server.")}var Mn,Wn=(Qn.prototype.operationForChild=function(t){if(this.path.isEmpty()){if(null!=this.affectedTree.value)return c(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;var e=this.affectedTree.subtree(new Pt(t));return new Qn(Pt.Empty,e,this.revert)}return c(this.path.getFront()===t,"operationForChild called for unrelated child."),new Qn(this.path.popFront(),this.affectedTree,this.revert)},Qn);function Qn(t,e,n){this.path=t,this.affectedTree=e,this.revert=n,this.type=On.ACK_USER_WRITE,this.source=An.User}var qn=(Un.fromObject=function(t){var e=Un.Empty;return bt(t,(function(t,n){e=e.set(new Pt(t),n)})),e},Un.prototype.isEmpty=function(){return null===this.value&&this.children.isEmpty()},Un.prototype.findRootMostMatchingPathAndValue=function(t,e){if(null!=this.value&&e(this.value))return{path:Pt.Empty,value:this.value};if(t.isEmpty())return null;var n=t.getFront(),r=this.children.get(n);if(null===r)return null;var i=r.findRootMostMatchingPathAndValue(t.popFront(),e);return null==i?null:{path:new Pt(n).child(i.path),value:i.value}},Un.prototype.findRootMostValueAndPath=function(t){return this.findRootMostMatchingPathAndValue(t,(function(){return!0}))},Un.prototype.subtree=function(t){if(t.isEmpty())return this;var e=t.getFront(),n=this.children.get(e);return null!==n?n.subtree(t.popFront()):Un.Empty},Un.prototype.set=function(t,e){if(t.isEmpty())return new Un(e,this.children);var n=t.getFront(),r=(this.children.get(n)||Un.Empty).set(t.popFront(),e),i=this.children.insert(n,r);return new Un(this.value,i)},Un.prototype.remove=function(t){if(t.isEmpty())return this.children.isEmpty()?Un.Empty:new Un(null,this.children);var e=t.getFront(),n=this.children.get(e);if(n){var r=n.remove(t.popFront()),i=void 0;return i=r.isEmpty()?this.children.remove(e):this.children.insert(e,r),null===this.value&&i.isEmpty()?Un.Empty:new Un(this.value,i)}return this},Un.prototype.get=function(t){if(t.isEmpty())return this.value;var e=t.getFront(),n=this.children.get(e);return n?n.get(t.popFront()):null},Un.prototype.setTree=function(t,e){if(t.isEmpty())return e;var n,r=t.getFront(),i=(this.children.get(r)||Un.Empty).setTree(t.popFront(),e);return n=i.isEmpty()?this.children.remove(r):this.children.insert(r,i),new Un(this.value,n)},Un.prototype.fold=function(t){return this.fold_(Pt.Empty,t)},Un.prototype.fold_=function(t,e){var n={};return this.children.inorderTraversal((function(r,i){n[r]=i.fold_(t.child(r),e)})),e(t,this.value,n)},Un.prototype.findOnPath=function(t,e){return this.findOnPath_(t,Pt.Empty,e)},Un.prototype.findOnPath_=function(t,e,n){var r=!!this.value&&n(e,this.value);if(r)return r;if(t.isEmpty())return null;var i=t.getFront(),o=this.children.get(i);return o?o.findOnPath_(t.popFront(),e.child(i),n):null},Un.prototype.foreachOnPath=function(t,e){return this.foreachOnPath_(t,Pt.Empty,e)},Un.prototype.foreachOnPath_=function(t,e,n){if(t.isEmpty())return this;this.value&&n(e,this.value);var r=t.getFront(),i=this.children.get(r);return i?i.foreachOnPath_(t.popFront(),e.child(r),n):Un.Empty},Un.prototype.foreach=function(t){this.foreach_(Pt.Empty,t)},Un.prototype.foreach_=function(t,e){this.children.inorderTraversal((function(n,r){r.foreach_(t.child(n),e)})),this.value&&e(t,this.value)},Un.prototype.foreachChild=function(t){this.children.inorderTraversal((function(e,n){n.value&&t(e,n.value)}))},Un.Empty=new Un(null),Un);function Un(t,e){void 0===e&&(e=Mn=Mn||new Ae(ht)),this.value=t,this.children=e}var Vn=(Hn.prototype.operationForChild=function(t){return this.path.isEmpty()?new Hn(this.source,Pt.Empty):new Hn(this.source,this.path.popFront())},Hn);function Hn(t,e){this.source=t,this.path=e,this.type=On.LISTEN_COMPLETE}var Bn=(jn.prototype.operationForChild=function(t){return this.path.isEmpty()?new jn(this.source,Pt.Empty,this.snap.getImmediateChild(t)):new jn(this.source,this.path.popFront(),this.snap)},jn);function jn(t,e,n){this.source=t,this.path=e,this.snap=n,this.type=On.OVERWRITE}var Yn=(Kn.prototype.operationForChild=function(t){if(this.path.isEmpty()){var e=this.children.subtree(new Pt(t));return e.isEmpty()?null:e.value?new Bn(this.source,Pt.Empty,e.value):new Kn(this.source,Pt.Empty,e)}return c(this.path.getFront()===t,"Can't get a merge for a child not on the path of the operation"),new Kn(this.source,this.path.popFront(),this.children)},Kn.prototype.toString=function(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"},Kn);function Kn(t,e,n){this.source=t,this.path=e,this.children=n,this.type=On.MERGE}var zn=(Gn.prototype.isFullyInitialized=function(){return this.fullyInitialized_},Gn.prototype.isFiltered=function(){return this.filtered_},Gn.prototype.isCompleteForPath=function(t){if(t.isEmpty())return this.isFullyInitialized()&&!this.filtered_;var e=t.getFront();return this.isCompleteForChild(e)},Gn.prototype.isCompleteForChild=function(t){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(t)},Gn.prototype.getNode=function(){return this.node_},Gn);function Gn(t,e,n){this.node_=t,this.fullyInitialized_=e,this.filtered_=n}var Xn=($n.prototype.updateEventSnap=function(t,e,n){return new $n(new zn(t,e,n),this.serverCache_)},$n.prototype.updateServerSnap=function(t,e,n){return new $n(this.eventCache_,new zn(t,e,n))},$n.prototype.getEventCache=function(){return this.eventCache_},$n.prototype.getCompleteEventSnap=function(){return this.eventCache_.isFullyInitialized()?this.eventCache_.getNode():null},$n.prototype.getServerCache=function(){return this.serverCache_},$n.prototype.getCompleteServerSnap=function(){return this.serverCache_.isFullyInitialized()?this.serverCache_.getNode():null},$n.Empty=new $n(new zn(Ge.EMPTY_NODE,!1,!1),new zn(Ge.EMPTY_NODE,!1,!1)),$n);function $n(t,e){this.eventCache_=t,this.serverCache_=e}var Jn=(Zn.valueChange=function(t){return new Zn(Zn.VALUE,t)},Zn.childAddedChange=function(t,e){return new Zn(Zn.CHILD_ADDED,e,t)},Zn.childRemovedChange=function(t,e){return new Zn(Zn.CHILD_REMOVED,e,t)},Zn.childChangedChange=function(t,e,n){return new Zn(Zn.CHILD_CHANGED,e,t,n)},Zn.childMovedChange=function(t,e){return new Zn(Zn.CHILD_MOVED,e,t)},Zn.CHILD_ADDED="child_added",Zn.CHILD_REMOVED="child_removed",Zn.CHILD_CHANGED="child_changed",Zn.CHILD_MOVED="child_moved",Zn.VALUE="value",Zn);function Zn(t,e,n,r,i){this.type=t,this.snapshotNode=e,this.childName=n,this.oldSnap=r,this.prevName=i}var tr=(er.prototype.updateChild=function(t,e,n,r,i,o){c(t.isIndexed(this.index_),"A node must be indexed if only a child is updated");var s=t.getImmediateChild(e);return s.getChild(r).equals(n.getChild(r))&&s.isEmpty()===n.isEmpty()?t:(null!=o&&(n.isEmpty()?t.hasChild(e)?o.trackChildChange(Jn.childRemovedChange(e,s)):c(t.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):s.isEmpty()?o.trackChildChange(Jn.childAddedChange(e,n)):o.trackChildChange(Jn.childChangedChange(e,n,s))),t.isLeafNode()&&n.isEmpty()?t:t.updateImmediateChild(e,n).withIndex(this.index_))},er.prototype.updateFullNode=function(t,e,n){return null!=n&&(t.isLeafNode()||t.forEachChild(Re,(function(t,r){e.hasChild(t)||n.trackChildChange(Jn.childRemovedChange(t,r))})),e.isLeafNode()||e.forEachChild(Re,(function(e,r){if(t.hasChild(e)){var i=t.getImmediateChild(e);i.equals(r)||n.trackChildChange(Jn.childChangedChange(e,r,i))}else n.trackChildChange(Jn.childAddedChange(e,r))}))),e.withIndex(this.index_)},er.prototype.updatePriority=function(t,e){return t.isEmpty()?Ge.EMPTY_NODE:t.updatePriority(e)},er.prototype.filtersNodes=function(){return!1},er.prototype.getIndexedFilter=function(){return this},er.prototype.getIndex=function(){return this.index_},er);function er(t){this.index_=t}var nr=(rr.prototype.trackChildChange=function(t){var e=t.type,n=t.childName;c(e===Jn.CHILD_ADDED||e===Jn.CHILD_CHANGED||e===Jn.CHILD_REMOVED,"Only child changes supported for tracking"),c(".priority"!==n,"Only non-priority child changes can be tracked.");var r=this.changeMap.get(n);if(r){var i=r.type;if(e===Jn.CHILD_ADDED&&i===Jn.CHILD_REMOVED)this.changeMap.set(n,Jn.childChangedChange(n,t.snapshotNode,r.snapshotNode));else if(e===Jn.CHILD_REMOVED&&i===Jn.CHILD_ADDED)this.changeMap.delete(n);else if(e===Jn.CHILD_REMOVED&&i===Jn.CHILD_CHANGED)this.changeMap.set(n,Jn.childRemovedChange(n,r.oldSnap));else if(e===Jn.CHILD_CHANGED&&i===Jn.CHILD_ADDED)this.changeMap.set(n,Jn.childAddedChange(n,t.snapshotNode));else{if(e!==Jn.CHILD_CHANGED||i!==Jn.CHILD_CHANGED)throw p("Illegal combination of changes: "+t+" occurred after "+r);this.changeMap.set(n,Jn.childChangedChange(n,t.snapshotNode,r.oldSnap))}}else this.changeMap.set(n,t)},rr.prototype.getChanges=function(){return Array.from(this.changeMap.values())},rr);function rr(){this.changeMap=new Map}function ir(){}var or=new(ir.prototype.getCompleteChild=function(t){return null},ir.prototype.getChildAfterChild=function(t,e,n){return null},ir),sr=(ar.prototype.getCompleteChild=function(t){var e=this.viewCache_.getEventCache();if(e.isCompleteForChild(t))return e.getNode().getImmediateChild(t);var n=null!=this.optCompleteServerCache_?new zn(this.optCompleteServerCache_,!0,!1):this.viewCache_.getServerCache();return this.writes_.calcCompleteChild(t,n)},ar.prototype.getChildAfterChild=function(t,e,n){var r=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:this.viewCache_.getCompleteServerSnap(),i=this.writes_.calcIndexedSlice(r,e,1,n,t);return 0===i.length?null:i[0]},ar);function ar(t,e,n){void 0===n&&(n=null),this.writes_=t,this.viewCache_=e,this.optCompleteServerCache_=n}var hr=function(t,e){this.viewCache=t,this.changes=e},lr=(ur.prototype.assertIndexed=function(t){c(t.getEventCache().getNode().isIndexed(this.filter_.getIndex()),"Event snap not indexed"),c(t.getServerCache().getNode().isIndexed(this.filter_.getIndex()),"Server snap not indexed")},ur.prototype.applyOperation=function(t,e,n,r){var i,o,s=new nr;if(e.type===On.OVERWRITE){var a=e;i=a.source.fromUser?this.applyUserOverwrite_(t,a.path,a.snap,n,r,s):(c(a.source.fromServer,"Unknown source."),o=a.source.tagged||t.getServerCache().isFiltered()&&!a.path.isEmpty(),this.applyServerOverwrite_(t,a.path,a.snap,n,r,o,s))}else if(e.type===On.MERGE){var h=e;i=h.source.fromUser?this.applyUserMerge_(t,h.path,h.children,n,r,s):(c(h.source.fromServer,"Unknown source."),o=h.source.tagged||t.getServerCache().isFiltered(),this.applyServerMerge_(t,h.path,h.children,n,r,o,s))}else if(e.type===On.ACK_USER_WRITE){var l=e;i=l.revert?this.revertUserWrite_(t,l.path,n,r,s):this.ackUserWrite_(t,l.path,l.affectedTree,n,r,s)}else{if(e.type!==On.LISTEN_COMPLETE)throw p("Unknown operation type: "+e.type);i=this.listenComplete_(t,e.path,n,s)}var u=s.getChanges();return ur.maybeAddValueEvent_(t,i,u),new hr(i,u)},ur.maybeAddValueEvent_=function(t,e,n){var r=e.getEventCache();if(r.isFullyInitialized()){var i=r.getNode().isLeafNode()||r.getNode().isEmpty(),o=t.getCompleteEventSnap();(0<n.length||!t.getEventCache().isFullyInitialized()||i&&!r.getNode().equals(o)||!r.getNode().getPriority().equals(o.getPriority()))&&n.push(Jn.valueChange(e.getCompleteEventSnap()))}},ur.prototype.generateEventCacheAfterServerEvent_=function(t,e,n,r,i){var o=t.getEventCache();if(null!=n.shadowingWrite(e))return t;var s=void 0,a=void 0;if(e.isEmpty())if(c(t.getServerCache().isFullyInitialized(),"If change path is empty, we must have complete server data"),t.getServerCache().isFiltered()){var h=t.getCompleteServerSnap(),l=h instanceof Ge?h:Ge.EMPTY_NODE,u=n.calcCompleteEventChildren(l);s=this.filter_.updateFullNode(t.getEventCache().getNode(),u,i)}else{var p=n.calcCompleteEventCache(t.getCompleteServerSnap());s=this.filter_.updateFullNode(t.getEventCache().getNode(),p,i)}else{var d=e.getFront();if(".priority"===d){c(1===e.getLength(),"Can't have a priority with additional path components");var f=o.getNode();a=t.getServerCache().getNode();var _=n.calcEventCacheAfterServerOverwrite(e,f,a);s=null!=_?this.filter_.updatePriority(f,_):o.getNode()}else{var y=e.popFront(),v=void 0;if(o.isCompleteForChild(d)){a=t.getServerCache().getNode();var g=n.calcEventCacheAfterServerOverwrite(e,o.getNode(),a);v=null!=g?o.getNode().getImmediateChild(d).updateChild(y,g):o.getNode().getImmediateChild(d)}else v=n.calcCompleteChild(d,t.getServerCache());s=null!=v?this.filter_.updateChild(o.getNode(),d,v,y,r,i):o.getNode()}}return t.updateEventSnap(s,o.isFullyInitialized()||e.isEmpty(),this.filter_.filtersNodes())},ur.prototype.applyServerOverwrite_=function(t,e,n,r,i,o,s){var a,h=t.getServerCache(),l=o?this.filter_:this.filter_.getIndexedFilter();if(e.isEmpty())a=l.updateFullNode(h.getNode(),n,null);else if(l.filtersNodes()&&!h.isFiltered()){var u=h.getNode().updateChild(e,n);a=l.updateFullNode(h.getNode(),u,null)}else{var c=e.getFront();if(!h.isCompleteForPath(e)&&1<e.getLength())return t;var p=e.popFront(),d=h.getNode().getImmediateChild(c).updateChild(p,n);a=".priority"===c?l.updatePriority(h.getNode(),d):l.updateChild(h.getNode(),c,d,p,or,null)}var f=t.updateServerSnap(a,h.isFullyInitialized()||e.isEmpty(),l.filtersNodes()),_=new sr(r,f,i);return this.generateEventCacheAfterServerEvent_(f,e,r,_,s)},ur.prototype.applyUserOverwrite_=function(t,e,n,r,i,o){var s,a,h=t.getEventCache(),l=new sr(r,t,i);if(e.isEmpty())a=this.filter_.updateFullNode(t.getEventCache().getNode(),n,o),s=t.updateEventSnap(a,!0,this.filter_.filtersNodes());else{var u=e.getFront();if(".priority"===u)a=this.filter_.updatePriority(t.getEventCache().getNode(),n),s=t.updateEventSnap(a,h.isFullyInitialized(),h.isFiltered());else{var c=e.popFront(),p=h.getNode().getImmediateChild(u),d=void 0;if(c.isEmpty())d=n;else{var f=l.getCompleteChild(u);d=null!=f?".priority"===c.getBack()&&f.getChild(c.parent()).isEmpty()?f:f.updateChild(c,n):Ge.EMPTY_NODE}if(p.equals(d))s=t;else{var _=this.filter_.updateChild(h.getNode(),u,d,c,l,o);s=t.updateEventSnap(_,h.isFullyInitialized(),this.filter_.filtersNodes())}}}return s},ur.cacheHasChild_=function(t,e){return t.getEventCache().isCompleteForChild(e)},ur.prototype.applyUserMerge_=function(t,e,n,r,i,o){var s=this,a=t;return n.foreach((function(n,h){var l=e.child(n);ur.cacheHasChild_(t,l.getFront())&&(a=s.applyUserOverwrite_(a,l,h,r,i,o))})),n.foreach((function(n,h){var l=e.child(n);ur.cacheHasChild_(t,l.getFront())||(a=s.applyUserOverwrite_(a,l,h,r,i,o))})),a},ur.prototype.applyMerge_=function(t,e){return e.foreach((function(e,n){t=t.updateChild(e,n)})),t},ur.prototype.applyServerMerge_=function(t,e,n,r,i,o,s){var a=this;if(t.getServerCache().getNode().isEmpty()&&!t.getServerCache().isFullyInitialized())return t;var h,l=t;h=e.isEmpty()?n:qn.Empty.setTree(e,n);var u=t.getServerCache().getNode();return h.children.inorderTraversal((function(e,n){if(u.hasChild(e)){var h=t.getServerCache().getNode().getImmediateChild(e),c=a.applyMerge_(h,n);l=a.applyServerOverwrite_(l,new Pt(e),c,r,i,o,s)}})),h.children.inorderTraversal((function(e,n){var h=!t.getServerCache().isCompleteForChild(e)&&null==n.value;if(!u.hasChild(e)&&!h){var c=t.getServerCache().getNode().getImmediateChild(e),p=a.applyMerge_(c,n);l=a.applyServerOverwrite_(l,new Pt(e),p,r,i,o,s)}})),l},ur.prototype.ackUserWrite_=function(t,e,n,r,i,o){if(null!=r.shadowingWrite(e))return t;var s=t.getServerCache().isFiltered(),a=t.getServerCache();if(null!=n.value){if(e.isEmpty()&&a.isFullyInitialized()||a.isCompleteForPath(e))return this.applyServerOverwrite_(t,e,a.getNode().getChild(e),r,i,s,o);if(e.isEmpty()){var h=qn.Empty;return a.getNode().forEachChild(ge,(function(t,e){h=h.set(new Pt(t),e)})),this.applyServerMerge_(t,e,h,r,i,s,o)}return t}var l=qn.Empty;return n.foreach((function(t,n){var r=e.child(t);a.isCompleteForPath(r)&&(l=l.set(t,a.getNode().getChild(r)))})),this.applyServerMerge_(t,e,l,r,i,s,o)},ur.prototype.listenComplete_=function(t,e,n,r){var i=t.getServerCache(),o=t.updateServerSnap(i.getNode(),i.isFullyInitialized()||e.isEmpty(),i.isFiltered());return this.generateEventCacheAfterServerEvent_(o,e,n,or,r)},ur.prototype.revertUserWrite_=function(t,e,n,r,i){var o;if(null!=n.shadowingWrite(e))return t;var s=new sr(n,t,r),a=t.getEventCache().getNode(),h=void 0;if(e.isEmpty()||".priority"===e.getFront()){var l=void 0;if(t.getServerCache().isFullyInitialized())l=n.calcCompleteEventCache(t.getCompleteServerSnap());else{var u=t.getServerCache().getNode();c(u instanceof Ge,"serverChildren would be complete if leaf node"),l=n.calcCompleteEventChildren(u)}l=l,h=this.filter_.updateFullNode(a,l,i)}else{var p=e.getFront(),d=n.calcCompleteChild(p,t.getServerCache());null==d&&t.getServerCache().isCompleteForChild(p)&&(d=a.getImmediateChild(p)),(h=null!=d?this.filter_.updateChild(a,p,d,e.popFront(),s,i):t.getEventCache().getNode().hasChild(p)?this.filter_.updateChild(a,p,Ge.EMPTY_NODE,e.popFront(),s,i):a).isEmpty()&&t.getServerCache().isFullyInitialized()&&(o=n.calcCompleteEventCache(t.getCompleteServerSnap())).isLeafNode()&&(h=this.filter_.updateFullNode(h,o,i))}return o=t.getServerCache().isFullyInitialized()||null!=n.shadowingWrite(Pt.Empty),t.updateEventSnap(h,o,this.filter_.filtersNodes())},ur);function ur(t){this.filter_=t}var cr=(pr.prototype.generateEventsForChanges=function(t,e,n){var r=this,i=[],o=[];return t.forEach((function(t){t.type===Jn.CHILD_CHANGED&&r.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&o.push(Jn.childMovedChange(t.childName,t.snapshotNode))})),this.generateEventsForType_(i,Jn.CHILD_REMOVED,t,n,e),this.generateEventsForType_(i,Jn.CHILD_ADDED,t,n,e),this.generateEventsForType_(i,Jn.CHILD_MOVED,o,n,e),this.generateEventsForType_(i,Jn.CHILD_CHANGED,t,n,e),this.generateEventsForType_(i,Jn.VALUE,t,n,e),i},pr.prototype.generateEventsForType_=function(t,e,n,r,i){var o=this,s=n.filter((function(t){return t.type===e}));s.sort(this.compareChanges_.bind(this)),s.forEach((function(e){var n=o.materializeSingleChange_(e,i);r.forEach((function(r){r.respondsTo(e.type)&&t.push(r.createEvent(n,o.query_))}))}))},pr.prototype.materializeSingleChange_=function(t,e){return"value"===t.type||"child_removed"===t.type||(t.prevName=e.getPredecessorChildName(t.childName,t.snapshotNode,this.index_)),t},pr.prototype.compareChanges_=function(t,e){if(null==t.childName||null==e.childName)throw p("Should only compare child_ events.");var n=new le(t.childName,t.snapshotNode),r=new le(e.childName,e.snapshotNode);return this.index_.compare(n,r)},pr);function pr(t){this.query_=t,this.index_=this.query_.getQueryParams().getIndex()}var dr,fr=(_r.prototype.getQuery=function(){return this.query_},_r.prototype.getServerCache=function(){return this.viewCache_.getServerCache().getNode()},_r.prototype.getCompleteServerCache=function(t){var e=this.viewCache_.getCompleteServerSnap();return e&&(this.query_.getQueryParams().loadsAllData()||!t.isEmpty()&&!e.getImmediateChild(t.getFront()).isEmpty())?e.getChild(t):null},_r.prototype.isEmpty=function(){return 0===this.eventRegistrations_.length},_r.prototype.addEventRegistration=function(t){this.eventRegistrations_.push(t)},_r.prototype.removeEventRegistration=function(t,e){var n=[];if(e){c(null==t,"A cancel should cancel all event registrations.");var r=this.query_.path;this.eventRegistrations_.forEach((function(t){e=e;var i=t.createCancelEvent(e,r);i&&n.push(i)}))}if(t){for(var i=[],o=0;o<this.eventRegistrations_.length;++o){var s=this.eventRegistrations_[o];if(s.matches(t)){if(t.hasAnyCallback()){i=i.concat(this.eventRegistrations_.slice(o+1));break}}else i.push(s)}this.eventRegistrations_=i}else this.eventRegistrations_=[];return n},_r.prototype.applyOperation=function(t,e,n){t.type===On.MERGE&&null!==t.source.queryId&&(c(this.viewCache_.getCompleteServerSnap(),"We should always have a full cache before handling merges"),c(this.viewCache_.getCompleteEventSnap(),"Missing event cache, even though we have a server cache"));var r=this.viewCache_,i=this.processor_.applyOperation(r,t,e,n);return this.processor_.assertIndexed(i.viewCache),c(i.viewCache.getServerCache().isFullyInitialized()||!r.getServerCache().isFullyInitialized(),"Once a server snap is complete, it should never go back"),this.viewCache_=i.viewCache,this.generateEventsForChanges_(i.changes,i.viewCache.getEventCache().getNode(),null)},_r.prototype.getInitialEvents=function(t){var e=this.viewCache_.getEventCache(),n=[];return e.getNode().isLeafNode()||e.getNode().forEachChild(Re,(function(t,e){n.push(Jn.childAddedChange(t,e))})),e.isFullyInitialized()&&n.push(Jn.valueChange(e.getNode())),this.generateEventsForChanges_(n,e.getNode(),t)},_r.prototype.generateEventsForChanges_=function(t,e,n){var r=n?[n]:this.eventRegistrations_;return this.eventGenerator_.generateEventsForChanges(t,e,r)},_r);function _r(t,e){this.query_=t,this.eventRegistrations_=[];var n=this.query_.getQueryParams(),r=new tr(n.getIndex()),i=n.getNodeFilter();this.processor_=new lr(i);var o=e.getServerCache(),s=e.getEventCache(),a=r.updateFullNode(Ge.EMPTY_NODE,o.getNode(),null),h=i.updateFullNode(Ge.EMPTY_NODE,s.getNode(),null),l=new zn(a,o.isFullyInitialized(),r.filtersNodes()),u=new zn(h,s.isFullyInitialized(),i.filtersNodes());this.viewCache_=new Xn(u,l),this.eventGenerator_=new cr(this.query_)}var yr=(Object.defineProperty(vr,"__referenceConstructor",{get:function(){return c(dr,"Reference.ts has not been loaded"),dr},set:function(t){c(!dr,"__referenceConstructor has already been defined"),dr=t},enumerable:!0,configurable:!0}),vr.prototype.isEmpty=function(){return 0===this.views.size},vr.prototype.applyOperation=function(t,e,n){var r,i,s=t.source.queryId;if(null!==s){var a=this.views.get(s);return c(null!=a,"SyncTree gave us an op for an invalid query."),a.applyOperation(t,e,n)}var h=[];try{for(var l=o(this.views.values()),u=l.next();!u.done;u=l.next())a=u.value,h=h.concat(a.applyOperation(t,e,n))}catch(t){r={error:t}}finally{try{u&&!u.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}return h},vr.prototype.addEventRegistration=function(t,e,n,r,i){var o=t.queryIdentifier(),s=this.views.get(o);if(!s){var a,h=n.calcCompleteEventCache(i?r:null);a=!!h||(h=r instanceof Ge?n.calcCompleteEventChildren(r):Ge.EMPTY_NODE,!1);var l=new Xn(new zn(h,a,!1),new zn(r,i,!1));s=new fr(t,l),this.views.set(o,s)}return s.addEventRegistration(e),s.getInitialEvents(e)},vr.prototype.removeEventRegistration=function(t,e,n){var r,i,a=t.queryIdentifier(),h=[],l=[],u=this.hasCompleteView();if("default"===a)try{for(var c=o(this.views.entries()),p=c.next();!p.done;p=c.next()){var d=s(p.value,2),f=d[0],_=d[1];l=l.concat(_.removeEventRegistration(e,n)),_.isEmpty()&&(this.views.delete(f),_.getQuery().getQueryParams().loadsAllData()||h.push(_.getQuery()))}}catch(t){r={error:t}}finally{try{p&&!p.done&&(i=c.return)&&i.call(c)}finally{if(r)throw r.error}}else(_=this.views.get(a))&&(l=l.concat(_.removeEventRegistration(e,n)),_.isEmpty()&&(this.views.delete(a),_.getQuery().getQueryParams().loadsAllData()||h.push(_.getQuery())));return u&&!this.hasCompleteView()&&h.push(new vr.__referenceConstructor(t.repo,t.path)),{removed:h,events:l}},vr.prototype.getQueryViews=function(){var t,e,n=[];try{for(var r=o(this.views.values()),i=r.next();!i.done;i=r.next()){var s=i.value;s.getQuery().getQueryParams().loadsAllData()||n.push(s)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return n},vr.prototype.getCompleteServerCache=function(t){var e,n,r=null;try{for(var i=o(this.views.values()),s=i.next();!s.done;s=i.next()){var a=s.value;r=r||a.getCompleteServerCache(t)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r},vr.prototype.viewForQuery=function(t){if(t.getQueryParams().loadsAllData())return this.getCompleteView();var e=t.queryIdentifier();return this.views.get(e)},vr.prototype.viewExistsForQuery=function(t){return null!=this.viewForQuery(t)},vr.prototype.hasCompleteView=function(){return null!=this.getCompleteView()},vr.prototype.getCompleteView=function(){var t,e;try{for(var n=o(this.views.values()),r=n.next();!r.done;r=n.next()){var i=r.value;if(i.getQuery().getQueryParams().loadsAllData())return i}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}return null},vr);function vr(){this.views=new Map}var gr=(mr.prototype.addWrite=function(t,e){if(t.isEmpty())return new mr(new qn(e));var n=this.writeTree_.findRootMostValueAndPath(t);if(null!=n){var r=n.path,i=n.value,o=Pt.relativePath(r,t);return i=i.updateChild(o,e),new mr(this.writeTree_.set(r,i))}var s=new qn(e);return new mr(this.writeTree_.setTree(t,s))},mr.prototype.addWrites=function(t,e){var n=this;return bt(e,(function(e,r){n=n.addWrite(t.child(e),r)})),n},mr.prototype.removeWrite=function(t){return t.isEmpty()?mr.Empty:new mr(this.writeTree_.setTree(t,qn.Empty))},mr.prototype.hasCompleteWrite=function(t){return null!=this.getCompleteNode(t)},mr.prototype.getCompleteNode=function(t){var e=this.writeTree_.findRootMostValueAndPath(t);return null!=e?this.writeTree_.get(e.path).getChild(Pt.relativePath(e.path,t)):null},mr.prototype.getCompleteChildren=function(){var t=[],e=this.writeTree_.value;return null!=e?e.isLeafNode()||e.forEachChild(Re,(function(e,n){t.push(new le(e,n))})):this.writeTree_.children.inorderTraversal((function(e,n){null!=n.value&&t.push(new le(e,n.value))})),t},mr.prototype.childCompoundWrite=function(t){if(t.isEmpty())return this;var e=this.getCompleteNode(t);return new mr(null!=e?new qn(e):this.writeTree_.subtree(t))},mr.prototype.isEmpty=function(){return this.writeTree_.isEmpty()},mr.prototype.apply=function(t){return function t(e,n,r){if(null!=n.value)return r.updateChild(e,n.value);var i=null;return n.children.inorderTraversal((function(n,o){".priority"===n?(c(null!==o.value,"Priority writes must always be leaf nodes"),i=o.value):r=t(e.child(n),o,r)})),r.getChild(e).isEmpty()||null===i||(r=r.updateChild(e.child(".priority"),i)),r}(Pt.Empty,this.writeTree_,t)},mr.Empty=new mr(new qn(null)),mr);function mr(t){this.writeTree_=t}var Cr=(Er.prototype.childWrites=function(t){return new wr(t,this)},Er.prototype.addOverwrite=function(t,e,n,r){c(n>this.lastWriteId_,"Stacking an older write on top of newer ones"),void 0===r&&(r=!0),this.allWrites_.push({path:t,snap:e,writeId:n,visible:r}),r&&(this.visibleWrites_=this.visibleWrites_.addWrite(t,e)),this.lastWriteId_=n},Er.prototype.addMerge=function(t,e,n){c(n>this.lastWriteId_,"Stacking an older merge on top of newer ones"),this.allWrites_.push({path:t,children:e,writeId:n,visible:!0}),this.visibleWrites_=this.visibleWrites_.addWrites(t,e),this.lastWriteId_=n},Er.prototype.getWrite=function(t){for(var e=0;e<this.allWrites_.length;e++){var n=this.allWrites_[e];if(n.writeId===t)return n}return null},Er.prototype.removeWrite=function(t){var e=this,n=this.allWrites_.findIndex((function(e){return e.writeId===t}));c(0<=n,"removeWrite called with nonexistent writeId.");var r=this.allWrites_[n];this.allWrites_.splice(n,1);for(var i=r.visible,o=!1,s=this.allWrites_.length-1;i&&0<=s;){var a=this.allWrites_[s];a.visible&&(n<=s&&this.recordContainsPath_(a,r.path)?i=!1:r.path.contains(a.path)&&(o=!0)),s--}return!!i&&(o?this.resetTree_():r.snap?this.visibleWrites_=this.visibleWrites_.removeWrite(r.path):bt(r.children,(function(t){e.visibleWrites_=e.visibleWrites_.removeWrite(r.path.child(t))})),!0)},Er.prototype.getCompleteWriteData=function(t){return this.visibleWrites_.getCompleteNode(t)},Er.prototype.calcCompleteEventCache=function(t,e,n,r){if(n||r){var i=this.visibleWrites_.childCompoundWrite(t);if(!r&&i.isEmpty())return e;if(r||null!=e||i.hasCompleteWrite(Pt.Empty)){var o=Er.layerTree_(this.allWrites_,(function(e){return(e.visible||r)&&(!n||!~n.indexOf(e.writeId))&&(e.path.contains(t)||t.contains(e.path))}),t);return h=e||Ge.EMPTY_NODE,o.apply(h)}return null}var s=this.visibleWrites_.getCompleteNode(t);if(null!=s)return s;var a=this.visibleWrites_.childCompoundWrite(t);if(a.isEmpty())return e;if(null!=e||a.hasCompleteWrite(Pt.Empty)){var h=e||Ge.EMPTY_NODE;return a.apply(h)}return null},Er.prototype.calcCompleteEventChildren=function(t,e){var n=Ge.EMPTY_NODE,r=this.visibleWrites_.getCompleteNode(t);if(r)return r.isLeafNode()||r.forEachChild(Re,(function(t,e){n=n.updateImmediateChild(t,e)})),n;if(e){var i=this.visibleWrites_.childCompoundWrite(t);return e.forEachChild(Re,(function(t,e){var r=i.childCompoundWrite(new Pt(t)).apply(e);n=n.updateImmediateChild(t,r)})),i.getCompleteChildren().forEach((function(t){n=n.updateImmediateChild(t.name,t.node)})),n}return this.visibleWrites_.childCompoundWrite(t).getCompleteChildren().forEach((function(t){n=n.updateImmediateChild(t.name,t.node)})),n},Er.prototype.calcEventCacheAfterServerOverwrite=function(t,e,n,r){c(n||r,"Either existingEventSnap or existingServerSnap must exist");var i=t.child(e);if(this.visibleWrites_.hasCompleteWrite(i))return null;var o=this.visibleWrites_.childCompoundWrite(i);return o.isEmpty()?r.getChild(e):o.apply(r.getChild(e))},Er.prototype.calcCompleteChild=function(t,e,n){var r=t.child(e),i=this.visibleWrites_.getCompleteNode(r);return null!=i?i:n.isCompleteForChild(e)?this.visibleWrites_.childCompoundWrite(r).apply(n.getNode().getImmediateChild(e)):null},Er.prototype.shadowingWrite=function(t){return this.visibleWrites_.getCompleteNode(t)},Er.prototype.calcIndexedSlice=function(t,e,n,r,i,o){var s,a=this.visibleWrites_.childCompoundWrite(t),h=a.getCompleteNode(Pt.Empty);if(null!=h)s=h;else{if(null==e)return[];s=a.apply(e)}if((s=s.withIndex(o)).isEmpty()||s.isLeafNode())return[];for(var l=[],u=o.getCompare(),c=i?s.getReverseIteratorFrom(n,o):s.getIteratorFrom(n,o),p=c.getNext();p&&l.length<r;)0!==u(p,n)&&l.push(p),p=c.getNext();return l},Er.prototype.recordContainsPath_=function(t,e){if(t.snap)return t.path.contains(e);for(var n in t.children)if(t.children.hasOwnProperty(n)&&t.path.child(n).contains(e))return!0;return!1},Er.prototype.resetTree_=function(){this.visibleWrites_=Er.layerTree_(this.allWrites_,Er.DefaultFilter_,Pt.Empty),0<this.allWrites_.length?this.lastWriteId_=this.allWrites_[this.allWrites_.length-1].writeId:this.lastWriteId_=-1},Er.DefaultFilter_=function(t){return t.visible},Er.layerTree_=function(t,e,n){for(var r=gr.Empty,i=0;i<t.length;++i){var o=t[i];if(e(o)){var s=o.path,a=void 0;if(o.snap)n.contains(s)?(a=Pt.relativePath(n,s),r=r.addWrite(a,o.snap)):s.contains(n)&&(a=Pt.relativePath(s,n),r=r.addWrite(Pt.Empty,o.snap.getChild(a)));else{if(!o.children)throw p("WriteRecord should have .snap or .children");if(n.contains(s))a=Pt.relativePath(n,s),r=r.addWrites(a,o.children);else if(s.contains(n))if((a=Pt.relativePath(s,n)).isEmpty())r=r.addWrites(Pt.Empty,o.children);else{var h=R(o.children,a.getFront());if(h){var l=h.getChild(a.popFront());r=r.addWrite(Pt.Empty,l)}}}}}return r},Er);function Er(){this.visibleWrites_=gr.Empty,this.allWrites_=[],this.lastWriteId_=-1}var wr=(br.prototype.calcCompleteEventCache=function(t,e,n){return this.writeTree_.calcCompleteEventCache(this.treePath_,t,e,n)},br.prototype.calcCompleteEventChildren=function(t){return this.writeTree_.calcCompleteEventChildren(this.treePath_,t)},br.prototype.calcEventCacheAfterServerOverwrite=function(t,e,n){return this.writeTree_.calcEventCacheAfterServerOverwrite(this.treePath_,t,e,n)},br.prototype.shadowingWrite=function(t){return this.writeTree_.shadowingWrite(this.treePath_.child(t))},br.prototype.calcIndexedSlice=function(t,e,n,r,i){return this.writeTree_.calcIndexedSlice(this.treePath_,t,e,n,r,i)},br.prototype.calcCompleteChild=function(t,e){return this.writeTree_.calcCompleteChild(this.treePath_,t,e)},br.prototype.child=function(t){return new br(this.treePath_.child(t),this.writeTree_)},br);function br(t,e){this.treePath_=t,this.writeTree_=e}var Sr=(Tr.prototype.applyUserOverwrite=function(t,e,n,r){return this.pendingWriteTree_.addOverwrite(t,e,n,r),r?this.applyOperationToSyncPoints_(new Bn(An.User,t,e)):[]},Tr.prototype.applyUserMerge=function(t,e,n){this.pendingWriteTree_.addMerge(t,e,n);var r=qn.fromObject(e);return this.applyOperationToSyncPoints_(new Yn(An.User,t,r))},Tr.prototype.ackUserWrite=function(t,e){void 0===e&&(e=!1);var n=this.pendingWriteTree_.getWrite(t);if(this.pendingWriteTree_.removeWrite(t)){var r=qn.Empty;return null!=n.snap?r=r.set(Pt.Empty,!0):bt(n.children,(function(t,e){r=r.set(new Pt(t),e)})),this.applyOperationToSyncPoints_(new Wn(n.path,r,e))}return[]},Tr.prototype.applyServerOverwrite=function(t,e){return this.applyOperationToSyncPoints_(new Bn(An.Server,t,e))},Tr.prototype.applyServerMerge=function(t,e){var n=qn.fromObject(e);return this.applyOperationToSyncPoints_(new Yn(An.Server,t,n))},Tr.prototype.applyListenComplete=function(t){return this.applyOperationToSyncPoints_(new Vn(An.Server,t))},Tr.prototype.applyTaggedQueryOverwrite=function(t,e,n){var r=this.queryKeyForTag_(n);if(null==r)return[];var i=Tr.parseQueryKey_(r),o=i.path,s=i.queryId,a=Pt.relativePath(o,t),h=new Bn(An.forServerTaggedQuery(s),a,e);return this.applyTaggedOperation_(o,h)},Tr.prototype.applyTaggedQueryMerge=function(t,e,n){var r=this.queryKeyForTag_(n);if(r){var i=Tr.parseQueryKey_(r),o=i.path,s=i.queryId,a=Pt.relativePath(o,t),h=qn.fromObject(e),l=new Yn(An.forServerTaggedQuery(s),a,h);return this.applyTaggedOperation_(o,l)}return[]},Tr.prototype.applyTaggedListenComplete=function(t,e){var n=this.queryKeyForTag_(e);if(n){var r=Tr.parseQueryKey_(n),i=r.path,o=r.queryId,s=Pt.relativePath(i,t),a=new Vn(An.forServerTaggedQuery(o),s);return this.applyTaggedOperation_(i,a)}return[]},Tr.prototype.addEventRegistration=function(t,e){var n=t.path,r=null,i=!1;this.syncPointTree_.foreachOnPath(n,(function(t,e){var o=Pt.relativePath(t,n);r=r||e.getCompleteServerCache(o),i=i||e.hasCompleteView()}));var o,s=this.syncPointTree_.get(n);s?(i=i||s.hasCompleteView(),r=r||s.getCompleteServerCache(Pt.Empty)):(s=new yr,this.syncPointTree_=this.syncPointTree_.set(n,s)),null!=r?o=!0:(o=!1,r=Ge.EMPTY_NODE,this.syncPointTree_.subtree(n).foreachChild((function(t,e){var n=e.getCompleteServerCache(Pt.Empty);n&&(r=r.updateImmediateChild(t,n))})));var a=s.viewExistsForQuery(t);if(!a&&!t.getQueryParams().loadsAllData()){var h=Tr.makeQueryKey_(t);c(!this.queryToTagMap.has(h),"View does not exist, but we have a tag");var l=Tr.getNextQueryTag_();this.queryToTagMap.set(h,l),this.tagToQueryMap.set(l,h)}var u=this.pendingWriteTree_.childWrites(n),p=s.addEventRegistration(t,e,u,r,o);if(!a&&!i){var d=s.viewForQuery(t);p=p.concat(this.setupListener_(t,d))}return p},Tr.prototype.removeEventRegistration=function(t,e,n){var r=this,i=t.path,o=this.syncPointTree_.get(i),s=[];if(o&&("default"===t.queryIdentifier()||o.viewExistsForQuery(t))){var a=o.removeEventRegistration(t,e,n);o.isEmpty()&&(this.syncPointTree_=this.syncPointTree_.remove(i));var h=a.removed;s=a.events;var l=-1!==h.findIndex((function(t){return t.getQueryParams().loadsAllData()})),u=this.syncPointTree_.findOnPath(i,(function(t,e){return e.hasCompleteView()}));if(l&&!u){var c=this.syncPointTree_.subtree(i);if(!c.isEmpty())for(var p=this.collectDistinctViewsForSubTree_(c),d=0;d<p.length;++d){var f=p[d],_=f.getQuery(),y=this.createListenerForView_(f);this.listenProvider_.startListening(Tr.queryForListening_(_),this.tagForQuery_(_),y.hashFn,y.onComplete)}}!u&&0<h.length&&!n&&(l?this.listenProvider_.stopListening(Tr.queryForListening_(t),null):h.forEach((function(t){var e=r.queryToTagMap.get(Tr.makeQueryKey_(t));r.listenProvider_.stopListening(Tr.queryForListening_(t),e)}))),this.removeTags_(h)}return s},Tr.prototype.calcCompleteEventCache=function(t,e){var n=this.pendingWriteTree_,r=this.syncPointTree_.findOnPath(t,(function(e,n){var r=Pt.relativePath(e,t),i=n.getCompleteServerCache(r);if(i)return i}));return n.calcCompleteEventCache(t,r,e,!0)},Tr.prototype.collectDistinctViewsForSubTree_=function(t){return t.fold((function(t,e,n){if(e&&e.hasCompleteView())return[e.getCompleteView()];var r=[];return e&&(r=e.getQueryViews()),bt(n,(function(t,e){r=r.concat(e)})),r}))},Tr.prototype.removeTags_=function(t){for(var e=0;e<t.length;++e){var n=t[e];if(!n.getQueryParams().loadsAllData()){var r=Tr.makeQueryKey_(n),i=this.queryToTagMap.get(r);this.queryToTagMap.delete(r),this.tagToQueryMap.delete(i)}}},Tr.queryForListening_=function(t){return t.getQueryParams().loadsAllData()&&!t.getQueryParams().isDefault()?t.getRef():t},Tr.prototype.setupListener_=function(t,e){var n=t.path,r=this.tagForQuery_(t),i=this.createListenerForView_(e),o=this.listenProvider_.startListening(Tr.queryForListening_(t),r,i.hashFn,i.onComplete),s=this.syncPointTree_.subtree(n);if(r)c(!s.value.hasCompleteView(),"If we're adding a query, it shouldn't be shadowed");else for(var a=s.fold((function(t,e,n){if(!t.isEmpty()&&e&&e.hasCompleteView())return[e.getCompleteView().getQuery()];var r=[];return e&&(r=r.concat(e.getQueryViews().map((function(t){return t.getQuery()})))),bt(n,(function(t,e){r=r.concat(e)})),r})),h=0;h<a.length;++h){var l=a[h];this.listenProvider_.stopListening(Tr.queryForListening_(l),this.tagForQuery_(l))}return o},Tr.prototype.createListenerForView_=function(t){var e=this,n=t.getQuery(),r=this.tagForQuery_(n);return{hashFn:function(){return(t.getServerCache()||Ge.EMPTY_NODE).hash()},onComplete:function(t){if("ok"===t)return r?e.applyTaggedListenComplete(n.path,r):e.applyListenComplete(n.path);var i=function(t,e){var n="Unknown Error";"too_big"===t?n="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===t?n="Client doesn't have permission to access the desired data.":"unavailable"===t&&(n="The service is unavailable");var r=new Error(t+" at "+e.path.toString()+": "+n);return r.code=t.toUpperCase(),r}(t,n);return e.removeEventRegistration(n,null,i)}}},Tr.makeQueryKey_=function(t){return t.path.toString()+"$"+t.queryIdentifier()},Tr.parseQueryKey_=function(t){var e=t.indexOf("$");return c(-1!==e&&e<t.length-1,"Bad queryKey."),{queryId:t.substr(e+1),path:new Pt(t.substr(0,e))}},Tr.prototype.queryKeyForTag_=function(t){return this.tagToQueryMap.get(t)},Tr.prototype.tagForQuery_=function(t){var e=Tr.makeQueryKey_(t);return this.queryToTagMap.get(e)},Tr.getNextQueryTag_=function(){return Tr.nextQueryTag_++},Tr.prototype.applyTaggedOperation_=function(t,e){var n=this.syncPointTree_.get(t);c(n,"Missing sync point for query tag that we're tracking");var r=this.pendingWriteTree_.childWrites(t);return n.applyOperation(e,r,null)},Tr.prototype.applyOperationToSyncPoints_=function(t){return this.applyOperationHelper_(t,this.syncPointTree_,null,this.pendingWriteTree_.childWrites(Pt.Empty))},Tr.prototype.applyOperationHelper_=function(t,e,n,r){if(t.path.isEmpty())return this.applyOperationDescendantsHelper_(t,e,n,r);var i=e.get(Pt.Empty);null==n&&null!=i&&(n=i.getCompleteServerCache(Pt.Empty));var o=[],s=t.path.getFront(),a=t.operationForChild(s),h=e.children.get(s);if(h&&a){var l=n?n.getImmediateChild(s):null,u=r.child(s);o=o.concat(this.applyOperationHelper_(a,h,l,u))}return i&&(o=o.concat(i.applyOperation(t,r,n))),o},Tr.prototype.applyOperationDescendantsHelper_=function(t,e,n,r){var i=this,o=e.get(Pt.Empty);null==n&&null!=o&&(n=o.getCompleteServerCache(Pt.Empty));var s=[];return e.children.inorderTraversal((function(e,o){var a=n?n.getImmediateChild(e):null,h=r.child(e),l=t.operationForChild(e);l&&(s=s.concat(i.applyOperationDescendantsHelper_(l,o,a,h)))})),o&&(s=s.concat(o.applyOperation(t,r,n))),s},Tr.nextQueryTag_=1,Tr);function Tr(t){this.listenProvider_=t,this.syncPointTree_=qn.Empty,this.pendingWriteTree_=new Cr,this.tagToQueryMap=new Map,this.queryToTagMap=new Map}var Ir=(Nr.prototype.getNode=function(t){return this.rootNode_.getChild(t)},Nr.prototype.updateSnapshot=function(t,e){this.rootNode_=this.rootNode_.updateChild(t,e)},Nr);function Nr(){this.rootNode_=Ge.EMPTY_NODE}var Rr=(Pr.prototype.getToken=function(t){return this.auth_?this.auth_.getToken(t).catch((function(t){return t&&"auth/token-not-initialized"===t.code?(nt("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)})):Promise.resolve(null)},Pr.prototype.addTokenChangeListener=function(t){this.auth_?this.auth_.addAuthTokenListener(t):(setTimeout((function(){return t(null)}),0),this.authProvider_.get().then((function(e){return e.addAuthTokenListener(t)})))},Pr.prototype.removeTokenChangeListener=function(t){this.authProvider_.get().then((function(e){return e.removeAuthTokenListener(t)}))},Pr.prototype.notifyForInvalidToken=function(){var t='Provided authentication credentials for the app named "'+this.app_.name+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.app_.options?t+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.app_.options?t+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':t+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',st(t)},Pr);function Pr(t,e){var n=this;this.app_=t,this.authProvider_=e,this.auth_=null,this.auth_=e.getImmediate({optional:!0}),this.auth_||e.get().then((function(t){return n.auth_=t}))}var Dr=(Or.prototype.incrementCounter=function(t,e){void 0===e&&(e=1),N(this.counters_,t)||(this.counters_[t]=0),this.counters_[t]+=e},Or.prototype.get=function(){return function(t){return function t(e,n){if(!(n instanceof Object))return n;switch(n.constructor){case Date:return new Date(n.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return n}for(var r in n)n.hasOwnProperty(r)&&(e[r]=t(e[r],n[r]));return e}(void 0,t)}(this.counters_)},Or);function Or(){this.counters_={}}var xr=(kr.getCollection=function(t){var e=t.toString();return this.collections_[e]||(this.collections_[e]=new Dr),this.collections_[e]},kr.getOrCreateReporter=function(t,e){var n=t.toString();return this.reporters_[n]||(this.reporters_[n]=e()),this.reporters_[n]},kr.collections_={},kr.reporters_={},kr);function kr(){}var Fr=(Ar.prototype.get=function(){var t=this.collection_.get(),e=i({},t);return this.last_&&bt(this.last_,(function(t,n){e[t]=e[t]-n})),this.last_=t,e},Ar);function Ar(t){this.collection_=t,this.last_=null}var Lr=(Mr.prototype.includeStat=function(t){this.statsToReport_[t]=!0},Mr.prototype.reportStats_=function(){var t=this,e=this.statsListener_.get(),n={},r=!1;bt(e,(function(e,i){0<i&&N(t.statsToReport_,e)&&(n[e]=i,r=!0)})),r&&this.server_.reportStats(n),It(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))},Mr);function Mr(t,e){this.server_=e,this.statsToReport_={},this.statsListener_=new Fr(t);var n=1e4+2e4*Math.random();It(this.reportStats_.bind(this),Math.floor(n))}var Wr=(Qr.prototype.queueEvents=function(t){for(var e=null,n=0;n<t.length;n++){var r=t[n],i=r.getPath();null===e||i.equals(e.getPath())||(this.eventLists_.push(e),e=null),null===e&&(e=new qr(i)),e.add(r)}e&&this.eventLists_.push(e)},Qr.prototype.raiseEventsAtPath=function(t,e){this.queueEvents(e),this.raiseQueuedEventsMatchingPredicate_((function(e){return e.equals(t)}))},Qr.prototype.raiseEventsForChangedPath=function(t,e){this.queueEvents(e),this.raiseQueuedEventsMatchingPredicate_((function(e){return e.contains(t)||t.contains(e)}))},Qr.prototype.raiseQueuedEventsMatchingPredicate_=function(t){this.recursionDepth_++;for(var e=!0,n=0;n<this.eventLists_.length;n++){var r=this.eventLists_[n];r&&(t(r.getPath())?(this.eventLists_[n].raise(),this.eventLists_[n]=null):e=!1)}e&&(this.eventLists_=[]),this.recursionDepth_--},Qr);function Qr(){this.eventLists_=[],this.recursionDepth_=0}var qr=(Ur.prototype.add=function(t){this.events_.push(t)},Ur.prototype.raise=function(){for(var t=0;t<this.events_.length;t++){var e=this.events_[t];if(null!==e){this.events_[t]=null;var n=e.getEventRunner();vt&&nt("event: "+e.toString()),Tt(n)}}},Ur.prototype.getPath=function(){return this.path_},Ur);function Ur(t){this.path_=t,this.events_=[]}var Vr=(Hr.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(Array.isArray(this.listeners_[t]))for(var r=a(this.listeners_[t]),i=0;i<r.length;i++)r[i].callback.apply(r[i].context,e)},Hr.prototype.on=function(t,e,n){this.validateEventType_(t),this.listeners_[t]=this.listeners_[t]||[],this.listeners_[t].push({callback:e,context:n});var r=this.getInitialEvent(t);r&&e.apply(n,r)},Hr.prototype.off=function(t,e,n){this.validateEventType_(t);for(var r=this.listeners_[t]||[],i=0;i<r.length;i++)if(r[i].callback===e&&(!n||n===r[i].context))return void r.splice(i,1)},Hr.prototype.validateEventType_=function(t){c(this.allowedEvents_.find((function(e){return e===t})),"Unknown event: "+t)},Hr);function Hr(t){this.allowedEvents_=t,this.listeners_={},c(Array.isArray(t)&&0<t.length,"Requires a non-empty array")}var Br,jr=(r(Yr,Br=Vr),Yr.getInstance=function(){return new Yr},Yr.prototype.getInitialEvent=function(t){return c("visible"===t,"Unknown event type: "+t),[this.visible_]},Yr);function Yr(){var t,e,n=Br.call(this,["visible"])||this;return"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(e="visibilitychange",t="hidden"):void 0!==document.mozHidden?(e="mozvisibilitychange",t="mozHidden"):void 0!==document.msHidden?(e="msvisibilitychange",t="msHidden"):void 0!==document.webkitHidden&&(e="webkitvisibilitychange",t="webkitHidden")),n.visible_=!0,e&&document.addEventListener(e,(function(){var e=!document[t];e!==n.visible_&&(n.visible_=e,n.trigger("visible",e))}),!1),n}var Kr,zr=(r(Gr,Kr=Vr),Gr.getInstance=function(){return new Gr},Gr.prototype.getInitialEvent=function(t){return c("online"===t,"Unknown event type: "+t),[this.online_]},Gr.prototype.currentlyOnline=function(){return this.online_},Gr);function Gr(){var t=Kr.call(this,["online"])||this;return t.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||y()||(window.addEventListener("online",(function(){t.online_||(t.online_=!0,t.trigger("online",!0))}),!1),window.addEventListener("offline",(function(){t.online_&&(t.online_=!1,t.trigger("online",!1))}),!1)),t}var Xr=($r.prototype.closeAfter=function(t,e){this.closeAfterResponse=t,this.onClose=e,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)},$r.prototype.handleResponse=function(t,e){var n=this;this.pendingResponses[t]=e;for(var r=function(){var t=i.pendingResponses[i.currentResponseNum];delete i.pendingResponses[i.currentResponseNum];for(var e=function(e){t[e]&&Tt((function(){n.onMessage_(t[e])}))},r=0;r<t.length;++r)e(r);if(i.currentResponseNum===i.closeAfterResponse)return i.onClose&&(i.onClose(),i.onClose=null),"break";i.currentResponseNum++},i=this;this.pendingResponses[this.currentResponseNum]&&"break"!==r(););},$r);function $r(t){this.onMessage_=t,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}var Jr=(Zr.prototype.open=function(t,e){var n=this;this.curSegmentNum=0,this.onDisconnect_=e,this.myPacketOrderer=new Xr(t),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout((function(){n.log_("Timed out trying to connect."),n.onClosed_(),n.connectTimeoutTimer_=null}),Math.floor(3e4)),function(t){if("complete"===document.readyState)t();else{var e=!1,n=function(){document.body?e||(e=!0,t()):setTimeout(n,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",(function(){"complete"===document.readyState&&n()})),window.attachEvent("onload",n))}}((function(){if(!n.isClosed_){n.scriptTagHolder=new ti((function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=s(t,5),i=r[0],o=r[1],a=r[2];if(r[3],r[4],n.incrementIncomingBytes_(t),n.scriptTagHolder)if(n.connectTimeoutTimer_&&(clearTimeout(n.connectTimeoutTimer_),n.connectTimeoutTimer_=null),n.everConnected_=!0,"start"===i)n.id=o,n.password=a;else{if("close"!==i)throw new Error("Unrecognized command received: "+i);o?(n.scriptTagHolder.sendNewPolls=!1,n.myPacketOrderer.closeAfter(o,(function(){n.onClosed_()}))):n.onClosed_()}}),(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=s(t,2),i=r[0],o=r[1];n.incrementIncomingBytes_(t),n.myPacketOrderer.handleResponse(i,o)}),(function(){n.onClosed_()}),n.urlFn);var t={start:"t"};t.ser=Math.floor(1e8*Math.random()),n.scriptTagHolder.uniqueCallbackIdentifier&&(t.cb=n.scriptTagHolder.uniqueCallbackIdentifier),t.v="5",n.transportSessionId&&(t.s=n.transportSessionId),n.lastSessionId&&(t.ls=n.lastSessionId),"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf(kt)&&(t.r="f");var e=n.urlFn(t);n.log_("Connecting via long-poll to "+e),n.scriptTagHolder.addTag(e,(function(){}))}}))},Zr.prototype.start=function(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)},Zr.forceAllow=function(){Zr.forceAllow_=!0},Zr.forceDisallow=function(){Zr.forceDisallow_=!0},Zr.isAvailable=function(){return!!Zr.forceAllow_||!(Zr.forceDisallow_||"undefined"==typeof document||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI)},Zr.prototype.markConnectionHealthy=function(){},Zr.prototype.shutdown_=function(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)},Zr.prototype.onClosed_=function(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))},Zr.prototype.close=function(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())},Zr.prototype.send=function(t){var e=T(t);this.bytesSent+=e.length,this.stats_.incrementCounter("bytes_sent",e.length);for(var n,r=ut((n=h(e),d.encodeByteArray(n,!0)),1840),i=0;i<r.length;i++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,r.length,r[i]),this.curSegmentNum++},Zr.prototype.addDisconnectPingFrame=function(t,e){this.myDisconnFrame=document.createElement("iframe");var n={dframe:"t"};n.id=t,n.pw=e,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)},Zr.prototype.incrementIncomingBytes_=function(t){var e=T(t).length;this.bytesReceived+=e,this.stats_.incrementCounter("bytes_received",e)},Zr);function Zr(t,e,n,r){this.connId=t,this.repoInfo=e,this.transportSessionId=n,this.lastSessionId=r,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=rt(t),this.stats_=xr.getCollection(e),this.urlFn=function(t){return e.connectionURL(At,t)}}var ti=(ei.createIFrame_=function(){var t=document.createElement("iframe");if(t.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(t);try{t.contentWindow.document||nt("No IE domain setting required")}catch(r){var e=document.domain;t.src="javascript:void((function(){document.open();document.domain='"+e+"';document.close();})())"}return t.contentDocument?t.doc=t.contentDocument:t.contentWindow?t.doc=t.contentWindow.document:t.document&&(t.doc=t.document),t},ei.prototype.close=function(){var t=this;this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout((function(){null!==t.myIFrame&&(document.body.removeChild(t.myIFrame),t.myIFrame=null)}),Math.floor(0)));var e=this.onDisconnect;e&&(this.onDisconnect=null,e())},ei.prototype.startLongPoll=function(t,e){for(this.myID=t,this.myPW=e,this.alive=!0;this.newRequest_(););},ei.prototype.newRequest_=function(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(0<this.pendingSegs.length?2:1)){this.currentSerial++;var t={};t.id=this.myID,t.pw=this.myPW,t.ser=this.currentSerial;for(var e=this.urlFn(t),n="",r=0;0<this.pendingSegs.length&&this.pendingSegs[0].d.length+30+n.length<=1870;){var i=this.pendingSegs.shift();n=n+"&seg"+r+"="+i.seg+"&ts"+r+"="+i.ts+"&d"+r+"="+i.d,r++}return e+=n,this.addLongPollTag_(e,this.currentSerial),!0}return!1},ei.prototype.enqueueSegment=function(t,e,n){this.pendingSegs.push({seg:t,ts:e,d:n}),this.alive&&this.newRequest_()},ei.prototype.addLongPollTag_=function(t,e){var n=this;function r(){n.outstandingRequests.delete(e),n.newRequest_()}this.outstandingRequests.add(e);var i=setTimeout(r,Math.floor(25e3));this.addTag(t,(function(){clearTimeout(i),r()}))},ei.prototype.addTag=function(t,e){var n=this;setTimeout((function(){try{if(!n.sendNewPolls)return;var r=n.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=t,r.onload=r.onreadystatechange=function(){var t=r.readyState;t&&"loaded"!==t&&"complete"!==t||(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),e())},r.onerror=function(){nt("Long-poll script failed to load: "+t),n.sendNewPolls=!1,n.close()},n.myIFrame.doc.body.appendChild(r)}catch(t){}}),Math.floor(1))},ei);function ei(t,e,n,r){this.onDisconnect=n,this.urlFn=r,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,this.uniqueCallbackIdentifier=_t(),window["pLPCommand"+this.uniqueCallbackIdentifier]=t,window["pRTLPCB"+this.uniqueCallbackIdentifier]=e,this.myIFrame=ei.createIFrame_();var i="";this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,"javascript:".length)&&(i='<script>document.domain="'+document.domain+'";<\/script>');var o="<html><body>"+i+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(t){nt("frame writing exception"),t.stack&&nt(t.stack),nt(t)}}var ni="",ri=null;"undefined"!=typeof MozWebSocket?ri=MozWebSocket:"undefined"!=typeof WebSocket&&(ri=WebSocket);var ii=(oi.connectionURL_=function(t,e,n){var r={v:"5"};return"undefined"!=typeof location&&location.href&&-1!==location.href.indexOf(kt)&&(r.r="f"),e&&(r.s=e),n&&(r.ls=n),t.connectionURL(Ft,r)},oi.prototype.open=function(e,n){var r=this;this.onDisconnect=n,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,pt.set("previous_websocket_failure",!0);try{if(v()){var i=u.NODE_ADMIN?"AdminNode":"Node",o={headers:{"User-Agent":"Firebase/5/"+ni+"/"+t.platform+"/"+i}},s=t.env,a=0===this.connURL.indexOf("wss://")?s.HTTPS_PROXY||s.https_proxy:s.HTTP_PROXY||s.http_proxy;a&&(o.proxy={origin:a}),this.mySock=new ri(this.connURL,[],o)}else this.mySock=new ri(this.connURL)}catch(e){this.log_("Error instantiating WebSocket.");var h=e.message||e.data;return h&&this.log_(h),void this.onClosed_()}this.mySock.onopen=function(){r.log_("Websocket connected."),r.everConnected_=!0},this.mySock.onclose=function(){r.log_("Websocket connection was disconnected."),r.mySock=null,r.onClosed_()},this.mySock.onmessage=function(t){r.handleIncomingFrame(t)},this.mySock.onerror=function(t){r.log_("WebSocket error.  Closing connection.");var e=t.message||t.data;e&&r.log_(e),r.onClosed_()}},oi.prototype.start=function(){},oi.forceDisallow=function(){oi.forceDisallow_=!0},oi.isAvailable=function(){var t=!1;if("undefined"!=typeof navigator&&navigator.userAgent){var e=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);e&&1<e.length&&parseFloat(e[1])<4.4&&(t=!0)}return!t&&null!==ri&&!oi.forceDisallow_},oi.previouslyFailed=function(){return pt.isInMemoryStorage||!0===pt.get("previous_websocket_failure")},oi.prototype.markConnectionHealthy=function(){pt.remove("previous_websocket_failure")},oi.prototype.appendFrame_=function(t){if(this.frames.push(t),this.frames.length===this.totalFrames){var e=this.frames.join("");this.frames=null;var n=S(e);this.onMessage(n)}},oi.prototype.handleNewFrameCount_=function(t){this.totalFrames=t,this.frames=[]},oi.prototype.extractFrameCount_=function(t){if(c(null===this.frames,"We already have a frame buffer"),t.length<=6){var e=Number(t);if(!isNaN(e))return this.handleNewFrameCount_(e),null}return this.handleNewFrameCount_(1),t},oi.prototype.handleIncomingFrame=function(t){if(null!==this.mySock){var e=t.data;if(this.bytesReceived+=e.length,this.stats_.incrementCounter("bytes_received",e.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(e);else{var n=this.extractFrameCount_(e);null!==n&&this.appendFrame_(n)}}},oi.prototype.send=function(t){this.resetKeepAlive();var e=T(t);this.bytesSent+=e.length,this.stats_.incrementCounter("bytes_sent",e.length);var n=ut(e,16384);1<n.length&&this.sendString_(String(n.length));for(var r=0;r<n.length;r++)this.sendString_(n[r])},oi.prototype.shutdown_=function(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)},oi.prototype.onClosed_=function(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))},oi.prototype.close=function(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())},oi.prototype.resetKeepAlive=function(){var t=this;clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval((function(){t.mySock&&t.sendString_("0"),t.resetKeepAlive()}),Math.floor(45e3))},oi.prototype.sendString_=function(t){try{this.mySock.send(t)}catch(t){this.log_("Exception thrown from WebSocket.send():",t.message||t.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}},oi.responsesRequiredToBeHealthy=2,oi.healthyTimeout=3e4,oi);function oi(t,e,n,r){this.connId=t,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=rt(this.connId),this.stats_=xr.getCollection(e),this.connURL=oi.connectionURL_(e,n,r)}var si=(Object.defineProperty(ai,"ALL_TRANSPORTS",{get:function(){return[Jr,ii]},enumerable:!0,configurable:!0}),ai.prototype.initTransports_=function(t){var e,n,r=ii&&ii.isAvailable(),i=r&&!ii.previouslyFailed();if(t.webSocketOnly&&(r||st("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[ii];else{var s=this.transports_=[];try{for(var a=o(ai.ALL_TRANSPORTS),h=a.next();!h.done;h=a.next()){var l=h.value;l&&l.isAvailable()&&s.push(l)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}}},ai.prototype.initialTransport=function(){if(0<this.transports_.length)return this.transports_[0];throw new Error("No transports available")},ai.prototype.upgradeTransport=function(){return 1<this.transports_.length?this.transports_[1]:null},ai);function ai(t){this.initTransports_(t)}var hi=(li.prototype.start_=function(){var t=this,e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,void 0,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout((function(){t.conn_&&t.conn_.open(n,r)}),Math.floor(0));var i=e.healthyTimeout||0;0<i&&(this.healthyTimeout_=It((function(){t.healthyTimeout_=null,t.isHealthy_||(t.conn_&&102400<t.conn_.bytesReceived?(t.log_("Connection exceeded healthy timeout but has received "+t.conn_.bytesReceived+" bytes.  Marking connection healthy."),t.isHealthy_=!0,t.conn_.markConnectionHealthy()):t.conn_&&10240<t.conn_.bytesSent?t.log_("Connection exceeded healthy timeout but has sent "+t.conn_.bytesSent+" bytes.  Leaving connection alive."):(t.log_("Closing unhealthy connection after timeout."),t.close()))}),Math.floor(i)))},li.prototype.nextTransportId_=function(){return"c:"+this.id+":"+this.connectionCount++},li.prototype.disconnReceiver_=function(t){var e=this;return function(n){t===e.conn_?e.onConnectionLost_(n):t===e.secondaryConn_?(e.log_("Secondary connection lost."),e.onSecondaryConnectionLost_()):e.log_("closing an old connection")}},li.prototype.connReceiver_=function(t){var e=this;return function(n){2!==e.state_&&(t===e.rx_?e.onPrimaryMessageReceived_(n):t===e.secondaryConn_?e.onSecondaryMessageReceived_(n):e.log_("message on old connection"))}},li.prototype.sendRequest=function(t){var e={t:"d",d:t};this.sendData_(e)},li.prototype.tryCleanupConnection=function(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)},li.prototype.onSecondaryControl_=function(t){if("t"in t){var e=t.t;"a"===e?this.upgradeIfSecondaryHealthy_():"r"===e?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===e&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}},li.prototype.onSecondaryMessageReceived_=function(t){var e=lt("t",t),n=lt("d",t);if("c"===e)this.onSecondaryControl_(n);else{if("d"!==e)throw new Error("Unknown protocol layer: "+e);this.pendingDataMessages.push(n)}},li.prototype.upgradeIfSecondaryHealthy_=function(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))},li.prototype.proceedWithUpgrade_=function(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()},li.prototype.onPrimaryMessageReceived_=function(t){var e=lt("t",t),n=lt("d",t);"c"===e?this.onControl_(n):"d"===e&&this.onDataMessage_(n)},li.prototype.onDataMessage_=function(t){this.onPrimaryResponse_(),this.onMessage_(t)},li.prototype.onPrimaryResponse_=function(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))},li.prototype.onControl_=function(t){var e=lt("t",t);if("d"in t){var n=t.d;if("h"===e)this.onHandshake_(n);else if("n"===e){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(var r=0;r<this.pendingDataMessages.length;++r)this.onDataMessage_(this.pendingDataMessages[r]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===e?this.onConnectionShutdown_(n):"r"===e?this.onReset_(n):"e"===e?it("Server Error: "+n):"o"===e?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):it("Unknown control packet command: "+e)}},li.prototype.onHandshake_=function(t){var e=t.ts,n=t.v,r=t.h;this.sessionId=t.s,this.repoInfo_.updateHost(r),0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,e),"5"!==n&&st("Protocol version mismatch detected"),this.tryStartUpgrade_())},li.prototype.tryStartUpgrade_=function(){var t=this.transportManager_.upgradeTransport();t&&this.startUpgrade_(t)},li.prototype.startUpgrade_=function(t){var e=this;this.secondaryConn_=new t(this.nextTransportId_(),this.repoInfo_,this.sessionId),this.secondaryResponsesRequired_=t.responsesRequiredToBeHealthy||0;var n=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(n,r),It((function(){e.secondaryConn_&&(e.log_("Timed out trying to upgrade."),e.secondaryConn_.close())}),Math.floor(6e4))},li.prototype.onReset_=function(t){this.log_("Reset packet received.  New host: "+t),this.repoInfo_.updateHost(t),1===this.state_?this.close():(this.closeConnections_(),this.start_())},li.prototype.onConnectionEstablished_=function(t,e){var n=this;this.log_("Realtime connection established."),this.conn_=t,this.state_=1,this.onReady_&&(this.onReady_(e,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):It((function(){n.sendPingOnPrimaryIfNecessary_()}),Math.floor(5e3))},li.prototype.sendPingOnPrimaryIfNecessary_=function(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))},li.prototype.onSecondaryConnectionLost_=function(){var t=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==t&&this.rx_!==t||this.close()},li.prototype.onConnectionLost_=function(t){this.conn_=null,t||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(pt.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()},li.prototype.onConnectionShutdown_=function(t){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(t),this.onKill_=null),this.onDisconnect_=null,this.close()},li.prototype.sendData_=function(t){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(t)},li.prototype.close=function(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))},li.prototype.closeConnections_=function(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)},li);function li(t,e,n,r,i,o,s){this.id=t,this.repoInfo_=e,this.onMessage_=n,this.onReady_=r,this.onDisconnect_=i,this.onKill_=o,this.lastSessionId=s,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=rt("c:"+this.id+":"),this.transportManager_=new si(e),this.log_("Connection created"),this.start_()}var ui=(ci.prototype.put=function(t,e,n,r){},ci.prototype.merge=function(t,e,n,r){},ci.prototype.refreshAuthToken=function(t){},ci.prototype.onDisconnectPut=function(t,e,n){},ci.prototype.onDisconnectMerge=function(t,e,n){},ci.prototype.onDisconnectCancel=function(t,e){},ci.prototype.reportStats=function(t){},ci);function ci(){}var pi,di=(r(fi,pi=ui),fi.prototype.sendRequest=function(t,e,n){var r=++this.requestNumber_,i={r:r,a:t,b:e};this.log_(T(i)),c(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(i),n&&(this.requestCBHash_[r]=n)},fi.prototype.listen=function(t,e,n,r){var i=t.queryIdentifier(),o=t.path.toString();this.log_("Listen called for "+o+" "+i),this.listens.has(o)||this.listens.set(o,new Map),c(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),"listen() called for non-default but complete query"),c(!this.listens.get(o).has(i),"listen() called twice for same path/queryId.");var s={onComplete:r,hashFn:e,query:t,tag:n};this.listens.get(o).set(i,s),this.connected_&&this.sendListen_(s)},fi.prototype.sendListen_=function(t){var e=this,n=t.query,r=n.path.toString(),i=n.queryIdentifier();this.log_("Listen on "+r+" for "+i);var o={p:r};t.tag&&(o.q=n.queryObject(),o.t=t.tag),o.h=t.hashFn(),this.sendRequest("q",o,(function(o){var s=o.d,a=o.s;fi.warnOnListenWarnings_(s,n),(e.listens.get(r)&&e.listens.get(r).get(i))===t&&(e.log_("listen response",o),"ok"!==a&&e.removeListen_(r,i),t.onComplete&&t.onComplete(a,s))}))},fi.warnOnListenWarnings_=function(t,e){if(t&&"object"==typeof t&&N(t,"w")){var n=R(t,"w");Array.isArray(n)&&~n.indexOf("no_index")&&st('Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ".indexOn": "'+e.getQueryParams().getIndex().toString()+'" at '+e.path.toString()+" to your security rules for better performance.")}},fi.prototype.refreshAuthToken=function(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},(function(){})),this.reduceReconnectDelayIfAdminCredential_(t)},fi.prototype.reduceReconnectDelayIfAdminCredential_=function(t){var e;(t&&40===t.length||"object"==typeof(e=I(t).claims)&&!0===e.admin)&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)},fi.prototype.tryAuth=function(){var t,e=this;if(this.connected_&&this.authToken_){var n=this.authToken_,r=(t=I(n).claims)&&"object"==typeof t&&t.hasOwnProperty("iat")?"auth":"gauth",i={cred:n};null===this.authOverride_?i.noauth=!0:"object"==typeof this.authOverride_&&(i.authvar=this.authOverride_),this.sendRequest(r,i,(function(t){var r=t.s,i=t.d||"error";e.authToken_===n&&("ok"===r?e.invalidAuthTokenCount_=0:e.onAuthRevoked_(r,i))}))}},fi.prototype.unlisten=function(t,e){var n=t.path.toString(),r=t.queryIdentifier();this.log_("Unlisten called for "+n+" "+r),c(t.getQueryParams().isDefault()||!t.getQueryParams().loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(n,r)&&this.connected_&&this.sendUnlisten_(n,r,t.queryObject(),e)},fi.prototype.sendUnlisten_=function(t,e,n,r){this.log_("Unlisten on "+t+" for "+e);var i={p:t};r&&(i.q=n,i.t=r),this.sendRequest("n",i)},fi.prototype.onDisconnectPut=function(t,e,n){this.connected_?this.sendOnDisconnect_("o",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:e,onComplete:n})},fi.prototype.onDisconnectMerge=function(t,e,n){this.connected_?this.sendOnDisconnect_("om",t,e,n):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:e,onComplete:n})},fi.prototype.onDisconnectCancel=function(t,e){this.connected_?this.sendOnDisconnect_("oc",t,null,e):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:e})},fi.prototype.sendOnDisconnect_=function(t,e,n,r){var i={p:e,d:n};this.log_("onDisconnect "+t,i),this.sendRequest(t,i,(function(t){r&&setTimeout((function(){r(t.s,t.d)}),Math.floor(0))}))},fi.prototype.put=function(t,e,n,r){this.putInternal("p",t,e,n,r)},fi.prototype.merge=function(t,e,n,r){this.putInternal("m",t,e,n,r)},fi.prototype.putInternal=function(t,e,n,r,i){var o={p:e,d:n};void 0!==i&&(o.h=i),this.outstandingPuts_.push({action:t,request:o,onComplete:r}),this.outstandingPutCount_++;var s=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(s):this.log_("Buffering put: "+e)},fi.prototype.sendPut_=function(t){var e=this,n=this.outstandingPuts_[t].action,r=this.outstandingPuts_[t].request,i=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(n,r,(function(r){e.log_(n+" response",r),delete e.outstandingPuts_[t],e.outstandingPutCount_--,0===e.outstandingPutCount_&&(e.outstandingPuts_=[]),i&&i(r.s,r.d)}))},fi.prototype.reportStats=function(t){var e=this;if(this.connected_){var n={c:t};this.log_("reportStats",n),this.sendRequest("s",n,(function(t){if("ok"!==t.s){var n=t.d;e.log_("reportStats","Error sending stats: "+n)}}))}},fi.prototype.onDataMessage_=function(t){if("r"in t){this.log_("from server: "+T(t));var e=t.r,n=this.requestCBHash_[e];n&&(delete this.requestCBHash_[e],n(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}},fi.prototype.onDataPush_=function(t,e){this.log_("handleServerMessage",t,e),"d"===t?this.onDataUpdate_(e.p,e.d,!1,e.t):"m"===t?this.onDataUpdate_(e.p,e.d,!0,e.t):"c"===t?this.onListenRevoked_(e.p,e.q):"ac"===t?this.onAuthRevoked_(e.s,e.d):"sd"===t?this.onSecurityDebugPacket_(e):it("Unrecognized action received from server: "+T(t)+"\nAre you using the latest client?")},fi.prototype.onReady_=function(t,e){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(t),this.lastSessionId=e,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)},fi.prototype.scheduleConnect_=function(t){var e=this;c(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout((function(){e.establishConnectionTimer_=null,e.establishConnection_()}),Math.floor(t))},fi.prototype.onVisible_=function(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)),this.visible_=t},fi.prototype.onOnline_=function(t){t?(this.log_("Browser went online."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())},fi.prototype.onRealtimeDisconnect_=function(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(3e4<(new Date).getTime()-this.lastConnectionEstablishedTime_&&(this.reconnectDelay_=1e3),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime());var t=(new Date).getTime()-this.lastConnectionAttemptTime_,e=Math.max(0,this.reconnectDelay_-t);e=Math.random()*e,this.log_("Trying to reconnect in "+e+"ms"),this.scheduleConnect_(e),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)},fi.prototype.establishConnection_=function(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;var t=this.onDataMessage_.bind(this),e=this.onReady_.bind(this),n=this.onRealtimeDisconnect_.bind(this),r=this.id+":"+fi.nextConnectionId_++,i=this,o=this.lastSessionId,s=!1,a=null,h=function(){a?a.close():(s=!0,n())};this.realtime_={close:h,sendRequest:function(t){c(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(t)}};var l=this.forceTokenRefresh_;this.forceTokenRefresh_=!1,this.authTokenProvider_.getToken(l).then((function(h){s?nt("getToken() completed but was canceled"):(nt("getToken() completed. Creating connection."),i.authToken_=h&&h.accessToken,a=new hi(r,i.repoInfo_,t,e,n,(function(t){st(t+" ("+i.repoInfo_.toString()+")"),i.interrupt("server_kill")}),o))})).then(null,(function(t){i.log_("Failed to get token: "+t),s||h()}))}},fi.prototype.interrupt=function(t){nt("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())},fi.prototype.resume=function(t){nt("Resuming connection for reason: "+t),delete this.interruptReasons_[t],P(this.interruptReasons_)&&(this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0))},fi.prototype.handleTimestamp_=function(t){var e=t-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:e})},fi.prototype.cancelSentTransactions_=function(){for(var t=0;t<this.outstandingPuts_.length;t++){var e=this.outstandingPuts_[t];e&&"h"in e.request&&e.queued&&(e.onComplete&&e.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])},fi.prototype.onListenRevoked_=function(t,e){var n;n=e?e.map((function(t){return wt(t)})).join("$"):"default";var r=this.removeListen_(t,n);r&&r.onComplete&&r.onComplete("permission_denied")},fi.prototype.removeListen_=function(t,e){var n,r=new Pt(t).toString();if(this.listens.has(r)){var i=this.listens.get(r);n=i.get(e),i.delete(e),0===i.size&&this.listens.delete(r)}else n=void 0;return n},fi.prototype.onAuthRevoked_=function(t,e){nt("Auth token revoked: "+t+"/"+e),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==t&&"permission_denied"!==t||(this.invalidAuthTokenCount_++,3<=this.invalidAuthTokenCount_&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))},fi.prototype.onSecurityDebugPacket_=function(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace("\n","\nFIREBASE: "))},fi.prototype.restoreState_=function(){var t,e,n,r;this.tryAuth();try{for(var i=o(this.listens.values()),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(a.values())),l=h.next();!l.done;l=h.next()){var u=l.value;this.sendListen_(u)}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}for(var c=0;c<this.outstandingPuts_.length;c++)this.outstandingPuts_[c]&&this.sendPut_(c);for(;this.onDisconnectRequestQueue_.length;){var p=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(p.action,p.pathString,p.data,p.onComplete)}},fi.prototype.sendConnectStats_=function(){var t={};t["sdk.js."+ni.replace(/\./g,"-")]=1,y()?t["framework.cordova"]=1:"object"==typeof navigator&&"ReactNative"===navigator.product&&(t["framework.reactnative"]=1),this.reportStats(t)},fi.prototype.shouldReconnect_=function(){var t=zr.getInstance().currentlyOnline();return P(this.interruptReasons_)&&t},fi.nextPersistentConnectionId_=0,fi.nextConnectionId_=0,fi);function fi(t,e,n,r,i,o){var s=pi.call(this)||this;if(s.repoInfo_=t,s.onDataUpdate_=e,s.onConnectStatus_=n,s.onServerInfoUpdate_=r,s.authTokenProvider_=i,s.authOverride_=o,s.id=fi.nextPersistentConnectionId_++,s.log_=rt("p:"+s.id+":"),s.interruptReasons_={},s.listens=new Map,s.outstandingPuts_=[],s.outstandingPutCount_=0,s.onDisconnectRequestQueue_=[],s.connected_=!1,s.reconnectDelay_=1e3,s.maxReconnectDelay_=3e5,s.securityDebugCallback_=null,s.lastSessionId=null,s.establishConnectionTimer_=null,s.visible_=!1,s.requestCBHash_={},s.requestNumber_=0,s.realtime_=null,s.authToken_=null,s.forceTokenRefresh_=!1,s.invalidAuthTokenCount_=0,s.firstConnection_=!0,s.lastConnectionAttemptTime_=null,s.lastConnectionEstablishedTime_=null,o&&!v())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");return s.scheduleConnect_(0),jr.getInstance().on("visible",s.onVisible_,s),-1===t.host.indexOf("fblocal")&&zr.getInstance().on("online",s.onOnline_,s),s}var _i,yi=(r(vi,_i=ui),vi.prototype.reportStats=function(t){throw new Error("Method not implemented.")},vi.getListenId_=function(t,e){return void 0!==e?"tag$"+e:(c(t.getQueryParams().isDefault(),"should have a tag if it's not a default query."),t.path.toString())},vi.prototype.listen=function(t,e,n,r){var i=this,o=t.path.toString();this.log_("Listen called for "+o+" "+t.queryIdentifier());var s=vi.getListenId_(t,n),a={};this.listens_[s]=a;var h=t.getQueryParams().toRestQueryStringParameters();this.restRequest_(o+".json",h,(function(t,e){var h=e;404===t&&(t=h=null),null===t&&i.onDataUpdate_(o,h,!1,n),R(i.listens_,s)===a&&r(t?401===t?"permission_denied":"rest_error:"+t:"ok",null)}))},vi.prototype.unlisten=function(t,e){var n=vi.getListenId_(t,e);delete this.listens_[n]},vi.prototype.refreshAuthToken=function(t){},vi.prototype.restRequest_=function(t,e,n){var r=this;void 0===e&&(e={}),e.format="export",this.authTokenProvider_.getToken(!1).then((function(i){var o=i&&i.accessToken;o&&(e.auth=o);var s=(r.repoInfo_.secure?"https://":"http://")+r.repoInfo_.host+t+"?ns="+r.repoInfo_.namespace+function(t){for(var e=[],n=function(t,n){Array.isArray(n)?n.forEach((function(n){e.push(encodeURIComponent(t)+"="+encodeURIComponent(n))})):e.push(encodeURIComponent(t)+"="+encodeURIComponent(n))},r=0,i=Object.entries(t);r<i.length;r++){var o=i[r];n(o[0],o[1])}return e.length?"&"+e.join("&"):""}(e);r.log_("Sending REST request for "+s);var a=new XMLHttpRequest;a.onreadystatechange=function(){if(n&&4===a.readyState){r.log_("REST Response for "+s+" received. status:",a.status,"response:",a.responseText);var t=null;if(200<=a.status&&a.status<300){try{t=S(a.responseText)}catch(t){st("Failed to parse JSON response for "+s+": "+a.responseText)}n(null,t)}else 401!==a.status&&404!==a.status&&st("Got unsuccessful REST response for "+s+" Status: "+a.status),n(a.status);n=null}},a.open("GET",s,!0),a.send()}))},vi);function vi(t,e,n){var r=_i.call(this)||this;return r.repoInfo_=t,r.onDataUpdate_=e,r.authTokenProvider_=n,r.log_=rt("p:rest:"),r.listens_={},r}var gi="repo_interrupt",mi=(Ci.prototype.toString=function(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host},Ci.prototype.name=function(){return this.repoInfo_.namespace},Ci.prototype.serverTime=function(){var t=this.infoData_.getNode(new Pt(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t},Ci.prototype.generateServerValues=function(){return(t=t={timestamp:this.serverTime()}).timestamp=t.timestamp||(new Date).getTime(),t;var t},Ci.prototype.onDataUpdate_=function(t,e,n,r){this.dataUpdateCount++;var i=new Pt(t);e=this.interceptServerDataCallback_?this.interceptServerDataCallback_(t,e):e;var o=[];if(r)if(n){var s=D(e,(function(t){return en(t)}));o=this.serverSyncTree_.applyTaggedQueryMerge(i,s,r)}else{var a=en(e);o=this.serverSyncTree_.applyTaggedQueryOverwrite(i,a,r)}else if(n){var h=D(e,(function(t){return en(t)}));o=this.serverSyncTree_.applyServerMerge(i,h)}else{var l=en(e);o=this.serverSyncTree_.applyServerOverwrite(i,l)}var u=i;0<o.length&&(u=this.rerunTransactions_(i)),this.eventQueue_.raiseEventsForChangedPath(u,o)},Ci.prototype.interceptServerData_=function(t){this.interceptServerDataCallback_=t},Ci.prototype.onConnectStatus_=function(t){this.updateInfo_("connected",t),!1===t&&this.runOnDisconnectEvents_()},Ci.prototype.onServerInfoUpdate_=function(t){var e=this;bt(t,(function(t,n){e.updateInfo_(t,n)}))},Ci.prototype.updateInfo_=function(t,e){var n=new Pt("/.info/"+t),r=en(e);this.infoData_.updateSnapshot(n,r);var i=this.infoSyncTree_.applyServerOverwrite(n,r);this.eventQueue_.raiseEventsForChangedPath(n,i)},Ci.prototype.getNextWriteId_=function(){return this.nextWriteId_++},Ci.prototype.setWithPriority=function(t,e,n,r){var i=this;this.log_("set",{path:t.toString(),value:e,priority:n});var o=this.generateServerValues(),s=en(e,n),a=In(s,this.serverSyncTree_.calcCompleteEventCache(t),o),h=this.getNextWriteId_(),l=this.serverSyncTree_.applyUserOverwrite(t,a,h,!0);this.eventQueue_.queueEvents(l),this.server_.put(t.toString(),s.val(!0),(function(e,n){var o="ok"===e;o||st("set at "+t+" failed: "+e);var s=i.serverSyncTree_.ackUserWrite(h,!o);i.eventQueue_.raiseEventsForChangedPath(t,s),i.callOnCompleteCallback(r,e,n)}));var u=this.abortTransactions_(t);this.rerunTransactions_(u),this.eventQueue_.raiseEventsForChangedPath(u,[])},Ci.prototype.update=function(t,e,n){var r=this;this.log_("update",{path:t.toString(),value:e});var i=!0,o=this.generateServerValues(),s={};if(bt(e,(function(e,n){i=!1,s[e]=Tn(t.child(e),en(n),r.serverSyncTree_,o)})),i)nt("update() called with empty data.  Don't do anything."),this.callOnCompleteCallback(n,"ok");else{var a=this.getNextWriteId_(),h=this.serverSyncTree_.applyUserMerge(t,s,a);this.eventQueue_.queueEvents(h),this.server_.merge(t.toString(),e,(function(e,i){var o="ok"===e;o||st("update at "+t+" failed: "+e);var s=r.serverSyncTree_.ackUserWrite(a,!o),h=0<s.length?r.rerunTransactions_(t):t;r.eventQueue_.raiseEventsForChangedPath(h,s),r.callOnCompleteCallback(n,e,i)})),bt(e,(function(e){var n=r.abortTransactions_(t.child(e));r.rerunTransactions_(n)})),this.eventQueue_.raiseEventsForChangedPath(t,[])}},Ci.prototype.runOnDisconnectEvents_=function(){var t=this;this.log_("onDisconnectEvents");var e=this.generateServerValues(),n=new kn;this.onDisconnect_.forEachTree(Pt.Empty,(function(r,i){var o=Tn(r,i,t.serverSyncTree_,e);n.remember(r,o)}));var r=[];n.forEachTree(Pt.Empty,(function(e,n){r=r.concat(t.serverSyncTree_.applyServerOverwrite(e,n));var i=t.abortTransactions_(e);t.rerunTransactions_(i)})),this.onDisconnect_=new kn,this.eventQueue_.raiseEventsForChangedPath(Pt.Empty,r)},Ci.prototype.onDisconnectCancel=function(t,e){var n=this;this.server_.onDisconnectCancel(t.toString(),(function(r,i){"ok"===r&&n.onDisconnect_.forget(t),n.callOnCompleteCallback(e,r,i)}))},Ci.prototype.onDisconnectSet=function(t,e,n){var r=this,i=en(e);this.server_.onDisconnectPut(t.toString(),i.val(!0),(function(e,o){"ok"===e&&r.onDisconnect_.remember(t,i),r.callOnCompleteCallback(n,e,o)}))},Ci.prototype.onDisconnectSetWithPriority=function(t,e,n,r){var i=this,o=en(e,n);this.server_.onDisconnectPut(t.toString(),o.val(!0),(function(e,n){"ok"===e&&i.onDisconnect_.remember(t,o),i.callOnCompleteCallback(r,e,n)}))},Ci.prototype.onDisconnectUpdate=function(t,e,n){var r=this;if(P(e))return nt("onDisconnect().update() called with empty data.  Don't do anything."),void this.callOnCompleteCallback(n,"ok");this.server_.onDisconnectMerge(t.toString(),e,(function(i,o){"ok"===i&&bt(e,(function(e,n){var i=en(n);r.onDisconnect_.remember(t.child(e),i)})),r.callOnCompleteCallback(n,i,o)}))},Ci.prototype.addEventCallbackForQuery=function(t,e){var n;n=".info"===t.path.getFront()?this.infoSyncTree_.addEventRegistration(t,e):this.serverSyncTree_.addEventRegistration(t,e),this.eventQueue_.raiseEventsAtPath(t.path,n)},Ci.prototype.removeEventCallbackForQuery=function(t,e){var n;n=".info"===t.path.getFront()?this.infoSyncTree_.removeEventRegistration(t,e):this.serverSyncTree_.removeEventRegistration(t,e),this.eventQueue_.raiseEventsAtPath(t.path,n)},Ci.prototype.interrupt=function(){this.persistentConnection_&&this.persistentConnection_.interrupt(gi)},Ci.prototype.resume=function(){this.persistentConnection_&&this.persistentConnection_.resume(gi)},Ci.prototype.stats=function(t){if(void 0===t&&(t=!1),"undefined"!=typeof console){var e;e=t?(this.statsListener_||(this.statsListener_=new Fr(this.stats_)),this.statsListener_.get()):this.stats_.get();var n=Object.keys(e).reduce((function(t,e){return Math.max(e.length,t)}),0);bt(e,(function(t,e){for(var r=t,i=t.length;i<n+2;i++)r+=" ";console.log(r+e)}))}},Ci.prototype.statsIncrementCounter=function(t){this.stats_.incrementCounter(t),this.statsReporter_.includeStat(t)},Ci.prototype.log_=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="";this.persistentConnection_&&(n=this.persistentConnection_.id+":"),nt.apply(void 0,a([n],t))},Ci.prototype.callOnCompleteCallback=function(t,e,n){t&&Tt((function(){if("ok"===e)t(null);else{var r=(e||"error").toUpperCase(),i=r;n&&(i+=": "+n);var o=new Error(i);o.code=r,t(o)}}))},Object.defineProperty(Ci.prototype,"database",{get:function(){return this.__database||(this.__database=new Qi(this))},enumerable:!0,configurable:!0}),Ci);function Ci(t,e,n,r){var i=this;this.repoInfo_=t,this.app=n,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Wr,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=new kn,this.persistentConnection_=null;var o=new Rr(n,r);if(this.stats_=xr.getCollection(t),e||0<=("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i))this.server_=new yi(this.repoInfo_,this.onDataUpdate_.bind(this),o),setTimeout(this.onConnectStatus_.bind(this,!0),0);else{var s=n.options.databaseAuthVariableOverride;if(null!=s){if("object"!=typeof s)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{T(s)}catch(t){throw new Error("Invalid authOverride provided: "+t)}}this.persistentConnection_=new di(this.repoInfo_,this.onDataUpdate_.bind(this),this.onConnectStatus_.bind(this),this.onServerInfoUpdate_.bind(this),o,s),this.server_=this.persistentConnection_}o.addTokenChangeListener((function(t){i.server_.refreshAuthToken(t)})),this.statsReporter_=xr.getOrCreateReporter(t,(function(){return new Lr(i.stats_,i.server_)})),this.transactionsInit_(),this.infoData_=new Ir,this.infoSyncTree_=new Sr({startListening:function(t,e,n,r){var o=[],s=i.infoData_.getNode(t.path);return s.isEmpty()||(o=i.infoSyncTree_.applyServerOverwrite(t.path,s),setTimeout((function(){r("ok")}),0)),o},stopListening:function(){}}),this.updateInfo_("connected",!1),this.serverSyncTree_=new Sr({startListening:function(t,e,n,r){return i.server_.listen(t,n,e,(function(e,n){var o=r(e,n);i.eventQueue_.raiseEventsForChangedPath(t.path,o)})),[]},stopListening:function(t,e){i.server_.unlisten(t,e)}})}var Ei=(wi.prototype.getStartPost=function(){return this.startPost_},wi.prototype.getEndPost=function(){return this.endPost_},wi.prototype.matches=function(t){return this.index_.compare(this.getStartPost(),t)<=0&&this.index_.compare(t,this.getEndPost())<=0},wi.prototype.updateChild=function(t,e,n,r,i,o){return this.matches(new le(e,n))||(n=Ge.EMPTY_NODE),this.indexedFilter_.updateChild(t,e,n,r,i,o)},wi.prototype.updateFullNode=function(t,e,n){e.isLeafNode()&&(e=Ge.EMPTY_NODE);var r=e.withIndex(this.index_);r=r.updatePriority(Ge.EMPTY_NODE);var i=this;return e.forEachChild(Re,(function(t,e){i.matches(new le(t,e))||(r=r.updateImmediateChild(t,Ge.EMPTY_NODE))})),this.indexedFilter_.updateFullNode(t,r,n)},wi.prototype.updatePriority=function(t,e){return t},wi.prototype.filtersNodes=function(){return!0},wi.prototype.getIndexedFilter=function(){return this.indexedFilter_},wi.prototype.getIndex=function(){return this.index_},wi.getStartPost_=function(t){if(t.hasStart()){var e=t.getIndexStartName();return t.getIndex().makePost(t.getIndexStartValue(),e)}return t.getIndex().minPost()},wi.getEndPost_=function(t){if(t.hasEnd()){var e=t.getIndexEndName();return t.getIndex().makePost(t.getIndexEndValue(),e)}return t.getIndex().maxPost()},wi);function wi(t){this.indexedFilter_=new tr(t.getIndex()),this.index_=t.getIndex(),this.startPost_=wi.getStartPost_(t),this.endPost_=wi.getEndPost_(t)}var bi=(Si.prototype.updateChild=function(t,e,n,r,i,o){return this.rangedFilter_.matches(new le(e,n))||(n=Ge.EMPTY_NODE),t.getImmediateChild(e).equals(n)?t:t.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(t,e,n,r,i,o):this.fullLimitUpdateChild_(t,e,n,i,o)},Si.prototype.updateFullNode=function(t,e,n){var r;if(e.isLeafNode()||e.isEmpty())r=Ge.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<e.numChildren()&&e.isIndexed(this.index_)){r=Ge.EMPTY_NODE.withIndex(this.index_);var i=void 0;i=this.reverse_?e.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):e.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);for(var o=0;i.hasNext()&&o<this.limit_;){var s=i.getNext();if(!(this.reverse_?this.index_.compare(this.rangedFilter_.getStartPost(),s)<=0:this.index_.compare(s,this.rangedFilter_.getEndPost())<=0))break;r=r.updateImmediateChild(s.name,s.node),o++}}else{r=(r=e.withIndex(this.index_)).updatePriority(Ge.EMPTY_NODE);var a=void 0,h=void 0,l=void 0;if(i=void 0,this.reverse_){i=r.getReverseIterator(this.index_),a=this.rangedFilter_.getEndPost(),h=this.rangedFilter_.getStartPost();var u=this.index_.getCompare();l=function(t,e){return u(e,t)}}else i=r.getIterator(this.index_),a=this.rangedFilter_.getStartPost(),h=this.rangedFilter_.getEndPost(),l=this.index_.getCompare();o=0;for(var c=!1;i.hasNext();)s=i.getNext(),!c&&l(a,s)<=0&&(c=!0),c&&o<this.limit_&&l(s,h)<=0?o++:r=r.updateImmediateChild(s.name,Ge.EMPTY_NODE)}return this.rangedFilter_.getIndexedFilter().updateFullNode(t,r,n)},Si.prototype.updatePriority=function(t,e){return t},Si.prototype.filtersNodes=function(){return!0},Si.prototype.getIndexedFilter=function(){return this.rangedFilter_.getIndexedFilter()},Si.prototype.getIndex=function(){return this.index_},Si.prototype.fullLimitUpdateChild_=function(t,e,n,r,i){var o;if(this.reverse_){var s=this.index_.getCompare();o=function(t,e){return s(e,t)}}else o=this.index_.getCompare();var a=t;c(a.numChildren()===this.limit_,"");var h=new le(e,n),l=this.reverse_?a.getFirstChild(this.index_):a.getLastChild(this.index_),u=this.rangedFilter_.matches(h);if(a.hasChild(e)){for(var p=a.getImmediateChild(e),d=r.getChildAfterChild(this.index_,l,this.reverse_);null!=d&&(d.name===e||a.hasChild(d.name));)d=r.getChildAfterChild(this.index_,d,this.reverse_);var f=null==d?1:o(d,h);if(u&&!n.isEmpty()&&0<=f)return null!=i&&i.trackChildChange(Jn.childChangedChange(e,n,p)),a.updateImmediateChild(e,n);null!=i&&i.trackChildChange(Jn.childRemovedChange(e,p));var _=a.updateImmediateChild(e,Ge.EMPTY_NODE);return null!=d&&this.rangedFilter_.matches(d)?(null!=i&&i.trackChildChange(Jn.childAddedChange(d.name,d.node)),_.updateImmediateChild(d.name,d.node)):_}return!n.isEmpty()&&u&&0<=o(l,h)?(null!=i&&(i.trackChildChange(Jn.childRemovedChange(l.name,l.node)),i.trackChildChange(Jn.childAddedChange(e,n))),a.updateImmediateChild(e,n).updateImmediateChild(l.name,Ge.EMPTY_NODE)):t},Si);function Si(t){this.rangedFilter_=new Ei(t),this.index_=t.getIndex(),this.limit_=t.getLimit(),this.reverse_=!t.isViewFromLeft()}var Ti=(Ii.prototype.hasStart=function(){return this.startSet_},Ii.prototype.isViewFromLeft=function(){return""===this.viewFrom_?this.startSet_:this.viewFrom_===Ii.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT},Ii.prototype.getIndexStartValue=function(){return c(this.startSet_,"Only valid if start has been set"),this.indexStartValue_},Ii.prototype.getIndexStartName=function(){return c(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:mt},Ii.prototype.hasEnd=function(){return this.endSet_},Ii.prototype.getIndexEndValue=function(){return c(this.endSet_,"Only valid if end has been set"),this.indexEndValue_},Ii.prototype.getIndexEndName=function(){return c(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Ct},Ii.prototype.hasLimit=function(){return this.limitSet_},Ii.prototype.hasAnchoredLimit=function(){return this.limitSet_&&""!==this.viewFrom_},Ii.prototype.getLimit=function(){return c(this.limitSet_,"Only valid if limit has been set"),this.limit_},Ii.prototype.getIndex=function(){return this.index_},Ii.prototype.copy_=function(){var t=new Ii;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t},Ii.prototype.limit=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_="",e},Ii.prototype.limitToFirst=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_=Ii.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_LEFT,e},Ii.prototype.limitToLast=function(t){var e=this.copy_();return e.limitSet_=!0,e.limit_=t,e.viewFrom_=Ii.WIRE_PROTOCOL_CONSTANTS_.VIEW_FROM_RIGHT,e},Ii.prototype.startAt=function(t,e){var n=this.copy_();return n.startSet_=!0,void 0===t&&(t=null),n.indexStartValue_=t,null!=e?(n.startNameSet_=!0,n.indexStartName_=e):(n.startNameSet_=!1,n.indexStartName_=""),n},Ii.prototype.endAt=function(t,e){var n=this.copy_();return n.endSet_=!0,void 0===t&&(t=null),n.indexEndValue_=t,void 0!==e?(n.endNameSet_=!0,n.indexEndName_=e):(n.endNameSet_=!1,n.indexEndName_=""),n},Ii.prototype.orderBy=function(t){var e=this.copy_();return e.index_=t,e},Ii.prototype.getQueryObject=function(){var t=Ii.WIRE_PROTOCOL_CONSTANTS_,e={};if(this.startSet_&&(e[t.INDEX_START_VALUE]=this.indexStartValue_,this.startNameSet_&&(e[t.INDEX_START_NAME]=this.indexStartName_)),this.endSet_&&(e[t.INDEX_END_VALUE]=this.indexEndValue_,this.endNameSet_&&(e[t.INDEX_END_NAME]=this.indexEndName_)),this.limitSet_){e[t.LIMIT]=this.limit_;var n=this.viewFrom_;""===n&&(n=this.isViewFromLeft()?t.VIEW_FROM_LEFT:t.VIEW_FROM_RIGHT),e[t.VIEW_FROM]=n}return this.index_!==Re&&(e[t.INDEX]=this.index_.toString()),e},Ii.prototype.loadsAllData=function(){return!(this.startSet_||this.endSet_||this.limitSet_)},Ii.prototype.isDefault=function(){return this.loadsAllData()&&this.index_===Re},Ii.prototype.getNodeFilter=function(){return this.loadsAllData()?new tr(this.getIndex()):new(this.hasLimit()?bi:Ei)(this)},Ii.prototype.toRestQueryStringParameters=function(){var t,e=Ii.REST_QUERY_CONSTANTS_,n={};return this.isDefault()||(t=this.index_===Re?e.PRIORITY_INDEX:this.index_===on?e.VALUE_INDEX:this.index_===ge?e.KEY_INDEX:(c(this.index_ instanceof sn,"Unrecognized index type!"),this.index_.toString()),n[e.ORDER_BY]=T(t),this.startSet_&&(n[e.START_AT]=T(this.indexStartValue_),this.startNameSet_&&(n[e.START_AT]+=","+T(this.indexStartName_))),this.endSet_&&(n[e.END_AT]=T(this.indexEndValue_),this.endNameSet_&&(n[e.END_AT]+=","+T(this.indexEndName_))),this.limitSet_&&(this.isViewFromLeft()?n[e.LIMIT_TO_FIRST]=this.limit_:n[e.LIMIT_TO_LAST]=this.limit_)),n},Ii.WIRE_PROTOCOL_CONSTANTS_={INDEX_START_VALUE:"sp",INDEX_START_NAME:"sn",INDEX_END_VALUE:"ep",INDEX_END_NAME:"en",LIMIT:"l",VIEW_FROM:"vf",VIEW_FROM_LEFT:"l",VIEW_FROM_RIGHT:"r",INDEX:"i"},Ii.REST_QUERY_CONSTANTS_={ORDER_BY:"orderBy",PRIORITY_INDEX:"$priority",VALUE_INDEX:"$value",KEY_INDEX:"$key",START_AT:"startAt",END_AT:"endAt",LIMIT_TO_FIRST:"limitToFirst",LIMIT_TO_LAST:"limitToLast"},Ii.DEFAULT=new Ii,Ii);function Ii(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=Re}var Ni,Ri=(r(Pi,Ni=mn),Pi.prototype.getKey=function(){return L("Reference.key",0,0,arguments.length),this.path.isEmpty()?null:this.path.getBack()},Pi.prototype.child=function(t){var e,n,r;return L("Reference.child",1,1,arguments.length),"number"==typeof t?t=String(t):t instanceof Pt||(null===this.path.getFront()?(r=!(e=1),Kt("Reference.child",e,n=(n=t)&&n.replace(/^\/*\.info(\/|$)/,"/"),r)):Kt("Reference.child",1,t,!1)),new Pi(this.repo,this.path.child(t))},Pi.prototype.getParent=function(){L("Reference.parent",0,0,arguments.length);var t=this.path.parent();return null===t?null:new Pi(this.repo,t)},Pi.prototype.getRoot=function(){L("Reference.root",0,0,arguments.length);for(var t=this;null!==t.getParent();)t=t.getParent();return t},Pi.prototype.databaseProp=function(){return this.repo.database},Pi.prototype.set=function(t,e){L("Reference.set",1,2,arguments.length),zt("Reference.set",this.path),Vt("Reference.set",1,t,this.path,!1),W("Reference.set",2,e,!0);var n=new f;return this.repo.setWithPriority(this.path,t,null,n.wrapCallback(e)),n.promise},Pi.prototype.update=function(t,e){if(L("Reference.update",1,2,arguments.length),zt("Reference.update",this.path),Array.isArray(t)){for(var n={},r=0;r<t.length;++r)n[""+r]=t[r];t=n,st("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Ht("Reference.update",1,t,this.path,!1),W("Reference.update",2,e,!0);var i=new f;return this.repo.update(this.path,t,i.wrapCallback(e)),i.promise},Pi.prototype.setWithPriority=function(t,e,n){if(L("Reference.setWithPriority",2,3,arguments.length),zt("Reference.setWithPriority",this.path),Vt("Reference.setWithPriority",1,t,this.path,!1),Bt("Reference.setWithPriority",2,e,!1),W("Reference.setWithPriority",3,n,!0),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.setWithPriority failed: "+this.getKey()+" is a read-only object.";var r=new f;return this.repo.setWithPriority(this.path,t,e,r.wrapCallback(n)),r.promise},Pi.prototype.remove=function(t){return L("Reference.remove",0,1,arguments.length),zt("Reference.remove",this.path),W("Reference.remove",1,t,!0),this.set(null,t)},Pi.prototype.transaction=function(t,e,n){if(L("Reference.transaction",1,3,arguments.length),zt("Reference.transaction",this.path),W("Reference.transaction",1,t,!1),W("Reference.transaction",2,e,!0),function(t,e,n,r){if(void 0!==n&&"boolean"!=typeof n)throw new Error(M("Reference.transaction",3,!0)+"must be a boolean.")}(0,0,n),".length"===this.getKey()||".keys"===this.getKey())throw"Reference.transaction failed: "+this.getKey()+" is a read-only object.";void 0===n&&(n=!0);var r=new f;return"function"==typeof e&&r.promise.catch((function(){})),this.repo.startTransaction(this.path,t,(function(t,n,i){t?r.reject(t):r.resolve(new re(n,i)),"function"==typeof e&&e(t,n,i)}),n),r.promise},Pi.prototype.setPriority=function(t,e){L("Reference.setPriority",1,2,arguments.length),zt("Reference.setPriority",this.path),Bt("Reference.setPriority",1,t,!1),W("Reference.setPriority",2,e,!0);var n=new f;return this.repo.setWithPriority(this.path.child(".priority"),t,null,n.wrapCallback(e)),n.promise},Pi.prototype.push=function(t,e){L("Reference.push",0,2,arguments.length),zt("Reference.push",this.path),Vt("Reference.push",1,t,this.path,!0),W("Reference.push",2,e,!0);var n,r=this.repo.serverTime(),i=he(r),o=this.child(i),s=this.child(i);return n=null!=t?o.set(t,e).then((function(){return s})):Promise.resolve(s),o.then=n.then.bind(n),o.catch=n.then.bind(n,void 0),"function"==typeof e&&n.catch((function(){})),o},Pi.prototype.onDisconnect=function(){return zt("Reference.onDisconnect",this.path),new ee(this.repo,this.path)},Object.defineProperty(Pi.prototype,"database",{get:function(){return this.databaseProp()},enumerable:!0,configurable:!0}),Object.defineProperty(Pi.prototype,"key",{get:function(){return this.getKey()},enumerable:!0,configurable:!0}),Object.defineProperty(Pi.prototype,"parent",{get:function(){return this.getParent()},enumerable:!0,configurable:!0}),Object.defineProperty(Pi.prototype,"root",{get:function(){return this.getRoot()},enumerable:!0,configurable:!0}),Pi);function Pi(t,e){if(!(t instanceof mi))throw new Error("new Reference() no longer supported - use app.database().");return Ni.call(this,t,e,Ti.DEFAULT,!1)||this}mn.__referenceConstructor=Ri,yr.__referenceConstructor=Ri;var Di,Oi,xi=function(){this.children={},this.childCount=0,this.value=null},ki=(Fi.prototype.subTree=function(t){for(var e=t instanceof Pt?t:new Pt(t),n=this,r=e.getFront();null!==r;)n=new Fi(r,n,R(n.node_.children,r)||new xi),r=(e=e.popFront()).getFront();return n},Fi.prototype.getValue=function(){return this.node_.value},Fi.prototype.setValue=function(t){c(void 0!==t,"Cannot set value to undefined"),this.node_.value=t,this.updateParents_()},Fi.prototype.clear=function(){this.node_.value=null,this.node_.children={},this.node_.childCount=0,this.updateParents_()},Fi.prototype.hasChildren=function(){return 0<this.node_.childCount},Fi.prototype.isEmpty=function(){return null===this.getValue()&&!this.hasChildren()},Fi.prototype.forEachChild=function(t){var e=this;bt(this.node_.children,(function(n,r){t(new Fi(n,e,r))}))},Fi.prototype.forEachDescendant=function(t,e,n){e&&!n&&t(this),this.forEachChild((function(e){e.forEachDescendant(t,!0,n)})),e&&n&&t(this)},Fi.prototype.forEachAncestor=function(t,e){for(var n=e?this:this.parent();null!==n;){if(t(n))return!0;n=n.parent()}return!1},Fi.prototype.forEachImmediateDescendantWithValue=function(t){this.forEachChild((function(e){null!==e.getValue()?t(e):e.forEachImmediateDescendantWithValue(t)}))},Fi.prototype.path=function(){return new Pt(null===this.parent_?this.name_:this.parent_.path()+"/"+this.name_)},Fi.prototype.name=function(){return this.name_},Fi.prototype.parent=function(){return this.parent_},Fi.prototype.updateParents_=function(){null!==this.parent_&&this.parent_.updateChild_(this.name_,this)},Fi.prototype.updateChild_=function(t,e){var n=e.isEmpty(),r=N(this.node_.children,t);n&&r?(delete this.node_.children[t],this.node_.childCount--,this.updateParents_()):n||r||(this.node_.children[t]=e.node_,this.node_.childCount++,this.updateParents_())},Fi);function Fi(t,e,n){void 0===t&&(t=""),void 0===e&&(e=null),void 0===n&&(n=new xi),this.name_=t,this.parent_=e,this.node_=n}(Oi=Di=Di||{})[Oi.RUN=0]="RUN",Oi[Oi.SENT=1]="SENT",Oi[Oi.COMPLETED=2]="COMPLETED",Oi[Oi.SENT_NEEDS_ABORT=3]="SENT_NEEDS_ABORT",Oi[Oi.NEEDS_ABORT=4]="NEEDS_ABORT",mi.MAX_TRANSACTION_RETRIES_=25,mi.prototype.transactionsInit_=function(){this.transactionQueueTree_=new ki},mi.prototype.startTransaction=function(t,e,n,r){function i(){}this.log_("transaction on "+t);var o=new Ri(this,t);o.on("value",i);var s={path:t,update:e,onComplete:n,status:null,order:_t(),applyLocally:r,retryCount:0,unwatcher:function(){o.off("value",i)},abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},a=this.getLatestState_(t);s.currentInputSnapshot=a;var h=s.update(a.val());if(void 0===h){if(s.unwatcher(),s.currentOutputSnapshotRaw=null,s.currentOutputSnapshotResolved=null,s.onComplete){var l=new hn(s.currentInputSnapshot,new Ri(this,s.path),Re);s.onComplete(null,!1,l)}}else{te("transaction failed: Data returned ",h,s.path),s.status=Di.RUN;var u=this.transactionQueueTree_.subTree(t),p=u.getValue()||[];p.push(s),u.setValue(p);var d=void 0;"object"==typeof h&&null!==h&&N(h,".priority")?(d=R(h,".priority"),c(Ut(d),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):d=(this.serverSyncTree_.calcCompleteEventCache(t)||Ge.EMPTY_NODE).getPriority().val(),d=d;var f=this.generateServerValues(),_=en(h,d),y=In(_,a,f);s.currentOutputSnapshotRaw=_,s.currentOutputSnapshotResolved=y,s.currentWriteId=this.getNextWriteId_();var v=this.serverSyncTree_.applyUserOverwrite(t,y,s.currentWriteId,s.applyLocally);this.eventQueue_.raiseEventsForChangedPath(t,v),this.sendReadyTransactions_()}},mi.prototype.getLatestState_=function(t,e){return this.serverSyncTree_.calcCompleteEventCache(t,e)||Ge.EMPTY_NODE},mi.prototype.sendReadyTransactions_=function(t){var e=this;if(void 0===t&&(t=this.transactionQueueTree_),t||this.pruneCompletedTransactionsBelowNode_(t),null!==t.getValue()){var n=this.buildTransactionQueue_(t);c(0<n.length,"Sending zero length transaction queue"),n.every((function(t){return t.status===Di.RUN}))&&this.sendTransactionQueue_(t.path(),n)}else t.hasChildren()&&t.forEachChild((function(t){e.sendReadyTransactions_(t)}))},mi.prototype.sendTransactionQueue_=function(t,e){for(var n=this,r=e.map((function(t){return t.currentWriteId})),i=this.getLatestState_(t,r),o=i,s=i.hash(),a=0;a<e.length;a++){var h=e[a];c(h.status===Di.RUN,"tryToSendTransactionQueue_: items in queue should all be run."),h.status=Di.SENT,h.retryCount++;var l=Pt.relativePath(t,h.path);o=o.updateChild(l,h.currentOutputSnapshotRaw)}var u=o.val(!0),p=t;this.server_.put(p.toString(),u,(function(r){n.log_("transaction put response",{path:p.toString(),status:r});var i=[];if("ok"===r){for(var o=[],s=0;s<e.length;s++){if(e[s].status=Di.COMPLETED,i=i.concat(n.serverSyncTree_.ackUserWrite(e[s].currentWriteId)),e[s].onComplete){var a=e[s].currentOutputSnapshotResolved,h=new Ri(n,e[s].path),l=new hn(a,h,Re);o.push(e[s].onComplete.bind(null,null,!0,l))}e[s].unwatcher()}for(n.pruneCompletedTransactionsBelowNode_(n.transactionQueueTree_.subTree(t)),n.sendReadyTransactions_(),n.eventQueue_.raiseEventsForChangedPath(t,i),s=0;s<o.length;s++)Tt(o[s])}else{if("datastale"===r)for(s=0;s<e.length;s++)e[s].status===Di.SENT_NEEDS_ABORT?e[s].status=Di.NEEDS_ABORT:e[s].status=Di.RUN;else for(st("transaction at "+p.toString()+" failed: "+r),s=0;s<e.length;s++)e[s].status=Di.NEEDS_ABORT,e[s].abortReason=r;n.rerunTransactions_(t)}}),s)},mi.prototype.rerunTransactions_=function(t){var e=this.getAncestorTransactionNode_(t),n=e.path(),r=this.buildTransactionQueue_(e);return this.rerunTransactionQueue_(r,n),n},mi.prototype.rerunTransactionQueue_=function(t,e){if(0!==t.length){for(var n,r=[],i=[],o=t.filter((function(t){return t.status===Di.RUN})).map((function(t){return t.currentWriteId})),s=0;s<t.length;s++){var a=t[s],h=Pt.relativePath(e,a.path),l=!1,u=void 0;if(c(null!==h,"rerunTransactionsUnderNode_: relativePath should not be null."),a.status===Di.NEEDS_ABORT)l=!0,u=a.abortReason,i=i.concat(this.serverSyncTree_.ackUserWrite(a.currentWriteId,!0));else if(a.status===Di.RUN)if(a.retryCount>=mi.MAX_TRANSACTION_RETRIES_)l=!0,u="maxretry",i=i.concat(this.serverSyncTree_.ackUserWrite(a.currentWriteId,!0));else{var p=this.getLatestState_(a.path,o);a.currentInputSnapshot=p;var d=t[s].update(p.val());if(void 0!==d){te("transaction failed: Data returned ",d,a.path);var f=en(d);"object"==typeof d&&null!=d&&N(d,".priority")||(f=f.updatePriority(p.getPriority()));var _=a.currentWriteId,y=In(f,p,this.generateServerValues());a.currentOutputSnapshotRaw=f,a.currentOutputSnapshotResolved=y,a.currentWriteId=this.getNextWriteId_(),o.splice(o.indexOf(_),1),i=(i=i.concat(this.serverSyncTree_.applyUserOverwrite(a.path,y,a.currentWriteId,a.applyLocally))).concat(this.serverSyncTree_.ackUserWrite(_,!0))}else l=!0,u="nodata",i=i.concat(this.serverSyncTree_.ackUserWrite(a.currentWriteId,!0))}if(this.eventQueue_.raiseEventsForChangedPath(e,i),i=[],l&&(t[s].status=Di.COMPLETED,n=t[s].unwatcher,setTimeout(n,Math.floor(0)),t[s].onComplete))if("nodata"===u){var v=new Ri(this,t[s].path),g=t[s].currentInputSnapshot,m=new hn(g,v,Re);r.push(t[s].onComplete.bind(null,null,!1,m))}else r.push(t[s].onComplete.bind(null,new Error(u),!1,null))}for(this.pruneCompletedTransactionsBelowNode_(this.transactionQueueTree_),s=0;s<r.length;s++)Tt(r[s]);this.sendReadyTransactions_()}},mi.prototype.getAncestorTransactionNode_=function(t){var e,n=this.transactionQueueTree_;for(e=t.getFront();null!==e&&null===n.getValue();)n=n.subTree(e),e=(t=t.popFront()).getFront();return n},mi.prototype.buildTransactionQueue_=function(t){var e=[];return this.aggregateTransactionQueuesForNode_(t,e),e.sort((function(t,e){return t.order-e.order})),e},mi.prototype.aggregateTransactionQueuesForNode_=function(t,e){var n=this,r=t.getValue();if(null!==r)for(var i=0;i<r.length;i++)e.push(r[i]);t.forEachChild((function(t){n.aggregateTransactionQueuesForNode_(t,e)}))},mi.prototype.pruneCompletedTransactionsBelowNode_=function(t){var e=this,n=t.getValue();if(n){for(var r=0,i=0;i<n.length;i++)n[i].status!==Di.COMPLETED&&(n[r]=n[i],r++);n.length=r,t.setValue(0<n.length?n:null)}t.forEachChild((function(t){e.pruneCompletedTransactionsBelowNode_(t)}))},mi.prototype.abortTransactions_=function(t){var e=this,n=this.getAncestorTransactionNode_(t).path(),r=this.transactionQueueTree_.subTree(t);return r.forEachAncestor((function(t){e.abortTransactionsOnNode_(t)})),this.abortTransactionsOnNode_(r),r.forEachDescendant((function(t){e.abortTransactionsOnNode_(t)})),n},mi.prototype.abortTransactionsOnNode_=function(t){var e=t.getValue();if(null!==e){for(var n=[],r=[],i=-1,o=0;o<e.length;o++)e[o].status!==Di.SENT_NEEDS_ABORT&&(e[o].status===Di.SENT?(c(i===o-1,"All SENT items should be at beginning of queue."),e[i=o].status=Di.SENT_NEEDS_ABORT,e[o].abortReason="set"):(c(e[o].status===Di.RUN,"Unexpected transaction status in abort"),e[o].unwatcher(),r=r.concat(this.serverSyncTree_.ackUserWrite(e[o].currentWriteId,!0)),e[o].onComplete&&n.push(e[o].onComplete.bind(null,new Error("set"),!1,null))));for(-1===i?t.setValue(null):e.length=i+1,this.eventQueue_.raiseEventsForChangedPath(t.path(),r),o=0;o<n.length;o++)Tt(n[o])}};var Ai,Li="databaseURL",Mi=(Wi.getInstance=function(){return Ai=Ai||new Wi},Wi.prototype.interrupt=function(){var t,e,n,r;try{for(var i=o(Object.keys(this.repos_)),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(Object.keys(this.repos_[a]))),l=h.next();!l.done;l=h.next()){var u=l.value;this.repos_[a][u].interrupt()}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},Wi.prototype.resume=function(){var t,e,n,r;try{for(var i=o(Object.keys(this.repos_)),s=i.next();!s.done;s=i.next()){var a=s.value;try{for(var h=(n=void 0,o(Object.keys(this.repos_[a]))),l=h.next();!l.done;l=h.next()){var u=l.value;this.repos_[a][u].resume()}}catch(e){n={error:e}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},Wi.prototype.databaseFromApp=function(e,n,r){var i=r||e.options[Li];void 0===i&&ot("Can't determine Firebase Database URL.  Be sure to include "+Li+" option when calling firebase.initializeApp().");var o=Wt(i),s=o.repoInfo,a=void 0;return"undefined"!=typeof t&&(a=t.env.FIREBASE_DATABASE_EMULATOR_HOST),a&&(s=(o=Wt(i="http://"+a+"?ns="+s.namespace)).repoInfo),Gt("Invalid Firebase Database URL",1,o),o.path.isEmpty()||ot("Database URL must point to the root of a Firebase Database (not including a child path)."),this.createRepo(s,e,n).database},Wi.prototype.deleteRepo=function(t){var e=R(this.repos_,t.app.name);e&&R(e,t.repoInfo_.toURLString())===t||ot("Database "+t.app.name+"("+t.repoInfo_+") has already been deleted."),t.interrupt(),delete e[t.repoInfo_.toURLString()]},Wi.prototype.createRepo=function(t,e,n){var r=R(this.repos_,e.name);r||(r={},this.repos_[e.name]=r);var i=R(r,t.toURLString());return i&&ot("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),i=new mi(t,this.useRestClient_,e,n),r[t.toURLString()]=i},Wi.prototype.forceRestClient=function(t){this.useRestClient_=t},Wi);function Wi(){this.repos_={},this.useRestClient_=!1}var Qi=(Object.defineProperty(qi.prototype,"app",{get:function(){return this.repo_.app},enumerable:!0,configurable:!0}),qi.prototype.ref=function(t){return this.checkDeleted_("ref"),L("database.ref",0,1,arguments.length),t instanceof Ri?this.refFromURL(t.toString()):void 0!==t?this.root_.child(t):this.root_},qi.prototype.refFromURL=function(t){var e="database.refFromURL";this.checkDeleted_(e),L(e,1,1,arguments.length);var n=Wt(t);Gt(e,1,n);var r=n.repoInfo;return r.host!==this.repo_.repoInfo_.host&&ot(e+": Host name does not match the current database: (found "+r.host+" but expected "+this.repo_.repoInfo_.host+")"),this.ref(n.path.toString())},qi.prototype.checkDeleted_=function(t){null===this.repo_&&ot("Cannot call "+t+" on a deleted database.")},qi.prototype.goOffline=function(){L("database.goOffline",0,0,arguments.length),this.checkDeleted_("goOffline"),this.repo_.interrupt()},qi.prototype.goOnline=function(){L("database.goOnline",0,0,arguments.length),this.checkDeleted_("goOnline"),this.repo_.resume()},qi.ServerValue={TIMESTAMP:{".sv":"timestamp"},increment:function(t){return{".sv":{increment:t}}}},qi);function qi(t){(this.repo_=t)instanceof mi||ot("Don't call new Database() directly - please use firebase.database()."),this.root_=new Ri(t,Pt.Empty),this.INTERNAL=new Ui(this)}var Ui=(Vi.prototype.delete=function(){return function(t,e,n,r){return new(n=n||Promise)((function(i,o){function s(t){try{h(r.next(t))}catch(t){o(t)}}function a(t){try{h(r.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?i(t.value):((e=t.value)instanceof n?e:new n((function(t){t(e)}))).then(s,a)}h((r=r.apply(t,e||[])).next())}))}(this,void 0,void 0,(function(){return function(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(a){o=[6,a],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}(this,(function(t){return this.database.checkDeleted_("delete"),Mi.getInstance().deleteRepo(this.database.repo_),this.database.repo_=null,this.database.root_=null,this.database.INTERNAL=null,this.database=null,[2]}))}))},Vi);function Vi(t){this.database=t}var Hi=Object.freeze({__proto__:null,forceLongPolling:function(){ii.forceDisallow(),Jr.forceAllow()},forceWebSockets:function(){Jr.forceDisallow()},isWebSocketsAvailable:function(){return ii.isAvailable()},setSecurityDebugCallback:function(t,e){t.repo.persistentConnection_.securityDebugCallback_=e},stats:function(t,e){t.repo.stats(e)},statsIncrementCounter:function(t,e){t.repo.statsIncrementCounter(e)},dataUpdateCount:function(t){return t.repo.dataUpdateCount},interceptServerData:function(t,e){return t.repo.interceptServerData_(e)}}),Bi=di;di.prototype.simpleListen=function(t,e){this.sendRequest("q",{p:t},e)},di.prototype.echo=function(t,e){this.sendRequest("echo",{d:t},e)};var ji,Yi,Ki=hi,zi=Lt,Gi=Object.freeze({__proto__:null,DataConnection:Bi,RealTimeConnection:Ki,hijackHash:function(t){var e=di.prototype.put;return di.prototype.put=function(n,r,i,o){void 0!==o&&(o=t()),e.call(this,n,r,i,o)},function(){di.prototype.put=e}},ConnectionTarget:zi,queryIdentifier:function(t){return t.queryIdentifier()},forceRestClient:function(t){Mi.getInstance().forceRestClient(t)}}),Xi=Qi.ServerValue;Yi=(ji=e).SDK_VERSION,ni=Yi,ji.INTERNAL.registerComponent(new K("database",(function(t,e){var n=t.getProvider("app").getImmediate(),r=t.getProvider("auth-internal");return Mi.getInstance().databaseFromApp(n,r,e)}),"PUBLIC").setServiceProps({Reference:Ri,Query:mn,Database:Qi,DataSnapshot:hn,enableLogging:et,INTERNAL:Hi,ServerValue:Xi,TEST_ACCESS:Gi}).setMultipleInstances(!0)),ji.registerVersion("@firebase/database","0.6.3")}).apply(this,arguments)}catch(n){throw console.error(n),new Error("Cannot instantiate firebase-database.js - be sure to load firebase-app.js first.")}}(n("wj3C"))}).call(this,n("8oxB"))}}]);